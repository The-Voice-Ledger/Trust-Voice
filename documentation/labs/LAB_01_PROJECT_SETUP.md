# TrustVoice - Lab 1: Project Setup & Foundation

**Learning Objectives:**
- Set up Python virtual environment (venv) following best practices
- Create complete project directory structure
- Configure development environment with all necessary dependencies
- Establish database connection and models
- Understand the project architecture and tech stack

**Prerequisites:**
- Python 3.11+ installed (`python3 --version`)
- PostgreSQL installed or Neon account created
- Git installed
- Code editor (VS Code recommended)
- Basic command line knowledge

**Time Estimate:** 2-3 hours  
**Difficulty:** Beginner

---

## üéØ Lab Overview: Building the Foundation

**What We're Building:**
TrustVoice is a voice-first donation platform connecting European/US donors to African NGO projects through conversational AI. Before we can build the AI, payments, and voice interfaces, we need a solid foundation.

**The Problem:**
Most development projects fail early because:
- Inconsistent directory structures lead to import confusion
- Missing dependencies cause runtime errors
- Database models aren't planned upfront
- Environment variables are hardcoded (security risk)
- No clear separation between development and production

**What This Lab Accomplishes:**
- ‚úÖ Virtual environment isolated from system Python
- ‚úÖ Complete directory structure ready to be filled
- ‚úÖ All dependencies installed and documented
- ‚úÖ Database models defined with relationships
- ‚úÖ Environment variables properly configured
- ‚úÖ Basic FastAPI server running with health check

---

## üìã System Architecture Overview

```
trustvoice/                          # Project root
‚îú‚îÄ‚îÄ venv/                            # Virtual environment (isolated)
‚îú‚îÄ‚îÄ .env                             # Environment variables (NEVER commit!)
‚îú‚îÄ‚îÄ .gitignore                       # Git exclusions
‚îú‚îÄ‚îÄ requirements.txt                 # Python dependencies
‚îú‚îÄ‚îÄ main.py                          # FastAPI application entry point
‚îú‚îÄ‚îÄ documentation/                   # All documentation & labs
‚îÇ   ‚îú‚îÄ‚îÄ LAB_01_PROJECT_SETUP.md
‚îÇ   ‚îú‚îÄ‚îÄ NGO_PLATFORM_PITCH.md
‚îÇ   ‚îú‚îÄ‚îÄ NGO_PLATFORM_TECHNICAL_SPEC.md
‚îÇ   ‚îî‚îÄ‚îÄ NGO_PLATFORM_DEVELOPMENT_PROMPT.md
‚îú‚îÄ‚îÄ database/                        # Database layer
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ models.py                    # SQLAlchemy models
‚îÇ   ‚îú‚îÄ‚îÄ db.py                        # Database utilities
‚îÇ   ‚îî‚îÄ‚îÄ migrations/                  # Alembic migrations
‚îÇ       ‚îî‚îÄ‚îÄ (generated by alembic)
‚îú‚îÄ‚îÄ voice/                           # Voice/chat interface layer
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ routers/                     # API route handlers
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ivr.py                   # Twilio voice calls
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ telegram.py              # Telegram bot
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ whatsapp.py              # WhatsApp messages
‚îÇ   ‚îú‚îÄ‚îÄ ai/                          # AI/ML components
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ conversation_manager.py  # Multi-turn dialogue
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ language_router.py       # Route by user language
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ intent_classifier.py     # Detect user intents
‚îÇ   ‚îú‚îÄ‚îÄ asr/                         # Speech recognition
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ asr_handler.py           # Whisper + local models
‚îÇ   ‚îî‚îÄ‚îÄ tasks/                       # Async background tasks
‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
‚îÇ       ‚îî‚îÄ‚îÄ celery_tasks.py
‚îú‚îÄ‚îÄ payments/                        # Payment processing
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ routers/                     
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ stripe_router.py         # Stripe integration
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ paypal_router.py         # PayPal integration
‚îÇ   ‚îî‚îÄ‚îÄ crypto/                      # Cryptocurrency payments
‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
‚îÇ       ‚îî‚îÄ‚îÄ web3_handler.py
‚îú‚îÄ‚îÄ blockchain/                      # Blockchain receipts
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ contracts/                   # Smart contracts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ DonationReceipt.sol
‚îÇ   ‚îú‚îÄ‚îÄ receipt_minter.py            # NFT minting
‚îÇ   ‚îî‚îÄ‚îÄ ipfs_client.py               # IPFS storage
‚îú‚îÄ‚îÄ utils/                           # Shared utilities
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ redis_client.py              # Redis connection
‚îÇ   ‚îî‚îÄ‚îÄ logger.py                    # Logging configuration
‚îî‚îÄ‚îÄ tests/                           # Test suite
    ‚îú‚îÄ‚îÄ __init__.py
    ‚îú‚îÄ‚îÄ test_api.py
    ‚îú‚îÄ‚îÄ test_ai.py
    ‚îî‚îÄ‚îÄ test_payments.py
```

---

## Step 1: Create Project Directory Structure

### üìö Background: Why This Structure?

**Modular Design:**
- `database/` - All database-related code in one place
- `voice/` - Multi-channel voice interfaces (IVR, Telegram, WhatsApp)
- `payments/` - Payment processing isolated for PCI compliance
- `blockchain/` - Blockchain receipts separate from core logic
- `utils/` - Shared code prevents duplication

**Benefits:**
- Easy to navigate for new developers
- Clear separation of concerns
- Simple to test individual modules
- Scales as project grows

### üíª Complete Setup Commands

Open your terminal and run these commands **exactly as shown**:

```bash
# Navigate to project root (already exists)
cd /Users/manu/Trust-Voice

# Create virtual environment (Python 3.11+)
python3 -m venv venv

# Activate virtual environment
# macOS/Linux:
source venv/bin/activate

# Verify activation (should show path to venv)
which python

# Create all project directories in one command
mkdir -p database/migrations \
         voice/{routers,ai,asr,tasks} \
         payments/{routers,crypto} \
         blockchain/contracts \
         utils \
         tests

# Create __init__.py files to make directories Python packages
touch database/__init__.py \
      database/migrations/__init__.py \
      voice/__init__.py \
      voice/routers/__init__.py \
      voice/ai/__init__.py \
      voice/asr/__init__.py \
      voice/tasks/__init__.py \
      payments/__init__.py \
      payments/routers/__init__.py \
      payments/crypto/__init__.py \
      blockchain/__init__.py \
      utils/__init__.py \
      tests/__init__.py

# Verify structure was created
tree -L 3 -I 'venv|__pycache__|*.pyc|documentation'
```

**Expected Output:**
```
.
‚îú‚îÄ‚îÄ blockchain
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îî‚îÄ‚îÄ contracts
‚îú‚îÄ‚îÄ database
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îî‚îÄ‚îÄ migrations
‚îÇ       ‚îî‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ main.py
‚îú‚îÄ‚îÄ payments
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ crypto
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ __init__.py
‚îÇ   ‚îî‚îÄ‚îÄ routers
‚îÇ       ‚îî‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ tests
‚îÇ   ‚îî‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ utils
‚îÇ   ‚îî‚îÄ‚îÄ __init__.py
‚îî‚îÄ‚îÄ voice
    ‚îú‚îÄ‚îÄ __init__.py
    ‚îú‚îÄ‚îÄ ai
    ‚îÇ   ‚îî‚îÄ‚îÄ __init__.py
    ‚îú‚îÄ‚îÄ asr
    ‚îÇ   ‚îî‚îÄ‚îÄ __init__.py
    ‚îú‚îÄ‚îÄ routers
    ‚îÇ   ‚îî‚îÄ‚îÄ __init__.py
    ‚îî‚îÄ‚îÄ tasks
        ‚îî‚îÄ‚îÄ __init__.py
```

---

## Step 2: Install Core Dependencies

### üìö Background: Dependency Management

**Virtual Environment (venv):**
- Isolates project dependencies from system Python
- Prevents version conflicts with other projects
- Makes deployment reproducible (`requirements.txt`)
- Used in your sister project - proven workflow

**Why These Dependencies:**

| Package | Purpose | Version |
|---------|---------|---------|
| `fastapi` | Async web framework | Latest |
| `uvicorn` | ASGI server for FastAPI | Latest |
| `sqlalchemy` | ORM for database | 2.0+ |
| `psycopg2-binary` | PostgreSQL driver | Latest |
| `alembic` | Database migrations | Latest |
| `redis` | Session caching | Latest |
| `celery` | Async task queue | Latest |
| `python-dotenv` | Load `.env` variables | Latest |

### üíª Installation Commands

```bash
# Ensure venv is activated (should see (venv) in prompt)
source venv/bin/activate

# Upgrade pip first
pip install --upgrade pip

# Install core dependencies
pip install fastapi uvicorn[standard] sqlalchemy psycopg2-binary alembic redis celery python-dotenv

# Install AI/ML libraries
pip install openai langchain pinecone-client

# Install payment libraries
pip install stripe paypal-sdk web3

# Install communication libraries
pip install twilio python-telegram-bot

# Install utilities
pip install pydantic python-multipart requests httpx

# Install testing libraries
pip install pytest pytest-asyncio httpx

# Freeze dependencies to requirements.txt
pip freeze > requirements.txt

# Verify installation
pip list
```

---

## Step 3: Create Environment Configuration

### üìö Background: Environment Variables

**Why `.env` Files:**
- **Security:** Never commit API keys to Git
- **Flexibility:** Different configs for dev/staging/prod
- **Best Practice:** 12-factor app methodology
- **Team Collaboration:** Each developer has their own `.env`

**What Goes in `.env`:**
- API keys (OpenAI, Stripe, Twilio)
- Database credentials
- Secret keys
- Service URLs

**What Doesn't:**
- Public information
- Code logic
- Default values (those go in code with `os.getenv('KEY', 'default')`)

### üíª Create `.env` File

```bash
# Create .env file
cat > .env << 'EOF'
# ============================================
# TrustVoice Environment Variables
# ============================================
# NEVER COMMIT THIS FILE TO GIT!
# Copy .env.example for team members
# ============================================

# ============================================
# DATABASE
# ============================================
# Local: postgresql://user:password@localhost:5432/trustvoice
# Neon (production): Get from https://neon.tech
DATABASE_URL=postgresql://user:password@localhost:5432/trustvoice

# ============================================
# REDIS (Session Caching)
# ============================================
# Local: redis://localhost:6379
# Production: Get from Redis Cloud
REDIS_URL=redis://localhost:6379

# ============================================
# AI/ML APIs
# ============================================
# OpenAI (European languages: EN/FR/DE/IT)
# Get from: https://platform.openai.com/api-keys
OPENAI_API_KEY=sk-proj-your-key-here

# Addis AI (Amharic/Swahili native)
# Get from: https://addisassistant.com
ADDIS_AI_API_KEY=sk_your-key-here
ADDIS_AI_URL=https://api.addisassistant.com/api/v1/chat_generate
ADDIS_TRANSLATE_URL=https://api.addisassistant.com/api/v1/translate

# ElevenLabs (Text-to-Speech)
# Get from: https://elevenlabs.io
ELEVENLABS_API_KEY=your-key-here

# Pinecone (Vector Database for RAG)
# Get from: https://www.pinecone.io
PINECONE_API_KEY=your-key-here
PINECONE_ENVIRONMENT=us-west1-gcp

# ============================================
# PAYMENT PROCESSING
# ============================================
# Stripe (Primary payment processor)
# Get from: https://dashboard.stripe.com/test/apikeys
STRIPE_SECRET_KEY=sk_test_your-key-here
STRIPE_PUBLISHABLE_KEY=pk_test_your-key-here
STRIPE_WEBHOOK_SECRET=whsec_your-webhook-secret

# PayPal (Alternative payment processor)
# Get from: https://developer.paypal.com
PAYPAL_CLIENT_ID=your-client-id
PAYPAL_CLIENT_SECRET=your-client-secret
PAYPAL_MODE=sandbox

# ============================================
# COMMUNICATION CHANNELS
# ============================================
# Twilio (IVR + WhatsApp)
# Get from: https://console.twilio.com
TWILIO_ACCOUNT_SID=ACxxxxxxxxxxxxxxxxxxxxxxxxxx
TWILIO_AUTH_TOKEN=your-auth-token
TWILIO_PHONE_NUMBER=+1234567890
TWILIO_WHATSAPP_NUMBER=whatsapp:+1234567890

# Telegram Bot
# Get from: https://t.me/BotFather
TELEGRAM_BOT_TOKEN=1234567890:ABCdefGHIjklMNOpqrsTUVwxyz

# ============================================
# BLOCKCHAIN (Optional - MVP can skip)
# ============================================
# Polygon RPC (for NFT receipts)
POLYGON_RPC_URL=https://polygon-rpc.com
POLYGON_PRIVATE_KEY=your-private-key-here

# IPFS (NFT.storage - free tier available)
# Get from: https://nft.storage
IPFS_API_KEY=your-ipfs-key

# ============================================
# APPLICATION SETTINGS
# ============================================
# Server
APP_ENV=development
APP_PORT=8000
APP_HOST=0.0.0.0

# Security
SECRET_KEY=your-secret-key-for-jwt-etc
ALLOWED_ORIGINS=http://localhost:3000,http://localhost:8000

# Monitoring
SENTRY_DSN=https://your-sentry-dsn

EOF

echo ".env file created!"
```

### Create `.env.example` (Safe to Commit)

```bash
# Create template for team members
cat > .env.example << 'EOF'
# Copy this file to .env and fill in your values
# NEVER commit .env to Git!

DATABASE_URL=postgresql://user:password@localhost:5432/trustvoice
REDIS_URL=redis://localhost:6379
OPENAI_API_KEY=sk-proj-your-key-here
STRIPE_SECRET_KEY=sk_test_your-key-here
TWILIO_ACCOUNT_SID=ACxxxxxxxxx
TELEGRAM_BOT_TOKEN=1234567890:ABC...
EOF
```

### Update `.gitignore`

```bash
# Create/update .gitignore
cat > .gitignore << 'EOF'
# Virtual Environment
venv/
env/
ENV/

# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python

# Environment Variables
.env
.env.local
.env.*.local

# Database
*.db
*.sqlite3
database/migrations/versions/*.py

# IDE
.vscode/
.idea/
*.swp
*.swo

# OS
.DS_Store
Thumbs.db

# Logs
*.log
logs/

# Testing
.pytest_cache/
.coverage
htmlcov/

# Build
dist/
build/
*.egg-info/
EOF

echo ".gitignore created!"
```

---

## Step 4: Create Database Models

### üìö Background: SQLAlchemy ORM

**Why SQLAlchemy:**
- **Type Safety:** Python classes ‚Üí SQL tables
- **Relationships:** Easy foreign keys and joins
- **Migrations:** Track schema changes with Alembic
- **Database Agnostic:** Works with PostgreSQL, MySQL, SQLite

**Database Design Principles:**
- **Normalization:** No duplicate data (e.g., campaign info not repeated in donations)
- **Indexes:** Fast lookups on phone numbers, campaign IDs
- **Relationships:** One NGO ‚Üí Many Campaigns ‚Üí Many Donations
- **Timestamps:** Track creation/updates for debugging

### üíª Create `database/models.py`

```python
"""
TrustVoice Database Models

This module defines all SQLAlchemy models for the TrustVoice platform.

Architecture:
- Donors: Individual users who donate via voice/chat
- NGOs: Organizations running campaigns
- Campaigns: Fundraising projects (e.g., "Mwanza Water Project")
- Donations: Individual contributions linked to donors and campaigns
- Impact Verifications: Field officer reports proving project completion
- Conversation Logs: AI conversation history for debugging/improvement
- Campaign Context: FAQ/story content for RAG (vector search)
"""

from sqlalchemy import (
    Column, Integer, String, Float, Boolean, DateTime, 
    Text, ForeignKey, ARRAY
)
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from datetime import datetime

Base = declarative_base()


class Donor(Base):
    """
    Individual donor who interacts via phone/Telegram/WhatsApp.
    
    Key Fields:
    - preferred_language: Set during registration (en/fr/de/it/am/sw)
      Used to route to correct AI (GPT-4 vs Addis AI)
    - phone_number: For IVR calls
    - telegram_user_id: For Telegram messages
    - whatsapp_number: For WhatsApp messages
    
    A donor may have multiple contact methods.
    """
    __tablename__ = "donors"
    
    id = Column(Integer, primary_key=True)
    
    # Contact Methods (at least one required)
    phone_number = Column(String(20), unique=True, index=True)
    telegram_user_id = Column(String(50), unique=True, index=True)
    whatsapp_number = Column(String(20), unique=True, index=True)
    
    # Profile
    preferred_name = Column(String(100))
    preferred_language = Column(String(10), default="en")  # CRITICAL: No auto-detection
    email = Column(String(255))
    country_code = Column(String(2))  # ISO 3166-1 alpha-2 (e.g., "DE", "US")
    
    # Payment Info
    blockchain_wallet_address = Column(String(66))  # Ethereum address (optional)
    stripe_customer_id = Column(String(100))  # Stripe Customer ID (auto-created)
    
    # Stats
    total_donated_usd = Column(Float, default=0.0)
    is_verified = Column(Boolean, default=False)  # Email/phone verified
    
    # Timestamps
    created_at = Column(DateTime, default=datetime.utcnow)
    last_interaction = Column(DateTime)
    
    # Relationships
    donations = relationship("Donation", back_populates="donor")


class NGOOrganization(Base):
    """
    NGO running fundraising campaigns.
    
    Examples:
    - WaterAid Tanzania
    - Ethiopian Education Foundation
    - Healthcare for All Kenya
    """
    __tablename__ = "ngo_organizations"
    
    id = Column(Integer, primary_key=True)
    
    # Basic Info
    name = Column(String(255), nullable=False)
    registration_number = Column(String(100))  # Government registration
    country = Column(String(100))
    contact_email = Column(String(255))
    admin_phone = Column(String(20))
    
    # Financial
    blockchain_wallet_address = Column(String(66))  # Where funds are sent
    stripe_account_id = Column(String(100))  # Stripe Connect account
    
    # Status
    is_active = Column(Boolean, default=True)
    created_at = Column(DateTime, default=datetime.utcnow)
    
    # Relationships
    campaigns = relationship("Campaign", back_populates="ngo")


class Campaign(Base):
    """
    Individual fundraising project.
    
    Example:
    - Title: "Clean Water for Mwanza"
    - Goal: $50,000
    - Description: "Build 10 wells serving 3,000 families"
    - Location: Mwanza, Tanzania (-2.5164, 32.9175)
    """
    __tablename__ = "campaigns"
    
    id = Column(Integer, primary_key=True)
    ngo_id = Column(Integer, ForeignKey("ngo_organizations.id"), nullable=False)
    
    # Basic Info
    title = Column(String(255), nullable=False)
    description = Column(Text)
    goal_amount_usd = Column(Float, nullable=False)
    raised_amount_usd = Column(Float, default=0.0)
    
    # Classification
    category = Column(String(50))  # water, education, health, infrastructure
    
    # Location
    location_country = Column(String(100))
    location_region = Column(String(100))
    location_gps = Column(String(100))  # "latitude,longitude"
    
    # Status
    status = Column(String(20), default="active")  # active, paused, completed, cancelled
    
    # Dates
    start_date = Column(DateTime)
    end_date = Column(DateTime)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    # Relationships
    ngo = relationship("NGOOrganization", back_populates="campaigns")
    donations = relationship("Donation", back_populates="campaign")
    verifications = relationship("ImpactVerification", back_populates="campaign")
    context_items = relationship("CampaignContext", back_populates="campaign")


class CampaignContext(Base):
    """
    Content for RAG (Retrieval-Augmented Generation).
    
    When donor asks "How will the money be used?", we search
    campaign_context table for relevant content using vector similarity.
    
    Content Types:
    - faq: Frequently asked questions
    - story: Beneficiary stories
    - budget: Detailed budget breakdown
    - partner_info: About implementing partners
    """
    __tablename__ = "campaign_context"
    
    id = Column(Integer, primary_key=True)
    campaign_id = Column(Integer, ForeignKey("campaigns.id"), nullable=False)
    
    content_type = Column(String(50))  # faq, story, budget, partner_info
    content = Column(Text, nullable=False)
    language = Column(String(10))  # en, fr, de, it, am, sw
    
    # Note: embedding_vector stored separately in Pinecone
    # (PostgreSQL pgvector extension is optional - adds complexity)
    
    created_at = Column(DateTime, default=datetime.utcnow)
    
    # Relationships
    campaign = relationship("Campaign", back_populates="context_items")


class Donation(Base):
    """
    Individual donation transaction.
    
    Lifecycle:
    1. pending: Payment intent created
    2. completed: Payment confirmed by Stripe/PayPal
    3. failed: Payment declined
    4. refunded: Donor requested refund
    """
    __tablename__ = "donations"
    
    id = Column(Integer, primary_key=True)
    donor_id = Column(Integer, ForeignKey("donors.id"), nullable=False)
    campaign_id = Column(Integer, ForeignKey("campaigns.id"), nullable=False)
    
    # Amount
    amount_usd = Column(Float, nullable=False)
    currency_code = Column(String(10), default="USD")  # EUR, GBP, USD
    original_amount = Column(Float)  # If currency != USD, store original
    
    # Payment Method
    payment_method = Column(String(20))  # stripe, paypal, crypto
    payment_intent_id = Column(String(255))  # Stripe Payment Intent ID
    transaction_hash = Column(String(66))  # If crypto, blockchain tx hash
    
    # Blockchain Receipt
    blockchain_receipt_url = Column(Text)  # IPFS URL with receipt NFT
    
    # Status
    status = Column(String(20), default="pending")
    
    # Optional Fields
    donor_message = Column(Text)  # "In memory of..."
    is_anonymous = Column(Boolean, default=False)
    tax_receipt_sent = Column(Boolean, default=False)
    
    # Timestamps
    created_at = Column(DateTime, default=datetime.utcnow)
    completed_at = Column(DateTime)
    
    # Relationships
    donor = relationship("Donor", back_populates="donations")
    campaign = relationship("Campaign", back_populates="donations")


class ImpactVerification(Base):
    """
    Field officer report proving project completion.
    
    Example:
    - Campaign: Mwanza Water Project
    - Verifier: Ibrahim (WaterAid field officer)
    - Type: milestone_completed
    - Description: "Well #3 completed, serving 450 families"
    - Audio: 30-second voice recording (IPFS URL)
    - Photos: [well_photo1.jpg, well_photo2.jpg] (IPFS URLs)
    - GPS: -2.5164, 32.9175
    - Blockchain: Anchored to Polygon with tx hash
    
    This verification is linked to all $100 donor receipts.
    """
    __tablename__ = "impact_verifications"
    
    id = Column(Integer, primary_key=True)
    campaign_id = Column(Integer, ForeignKey("campaigns.id"), nullable=False)
    
    # Field Officer Info
    verifier_phone = Column(String(20))
    verifier_name = Column(String(100))
    
    # Verification Details
    verification_type = Column(String(50))  # milestone, completion, beneficiary_count
    description = Column(Text)
    
    # Media
    audio_recording_url = Column(Text)  # IPFS URL
    photo_urls = Column(ARRAY(Text))  # Array of IPFS URLs
    
    # Location & Impact
    gps_coordinates = Column(String(100))  # "latitude,longitude"
    beneficiary_count = Column(Integer)  # Number of people impacted
    
    # Blockchain Anchor
    blockchain_anchor_tx = Column(String(66))  # Polygon transaction hash
    
    # Timestamp
    verified_at = Column(DateTime, default=datetime.utcnow)
    
    # Relationships
    campaign = relationship("Campaign", back_populates="verifications")


class ConversationLog(Base):
    """
    Logs all AI conversations for debugging and improvement.
    
    Use Cases:
    - Debug why AI misunderstood donor intent
    - Calculate LLM token usage (costs)
    - Improve conversation flows
    - Compliance (GDPR: user can request conversation history)
    """
    __tablename__ = "conversation_logs"
    
    id = Column(Integer, primary_key=True)
    donor_id = Column(Integer, ForeignKey("donors.id"))
    
    # Channel Info
    channel = Column(String(20))  # ivr, telegram, whatsapp
    session_id = Column(String(100))  # Groups messages in same conversation
    
    # Message Content
    message_type = Column(String(20))  # user, assistant, system
    message_text = Column(Text)
    
    # AI Metadata
    intent_detected = Column(String(50))  # ask_campaign_info, initiate_donation, etc.
    entities_extracted = Column(Text)  # JSON: {"campaign_id": 5, "amount": 100}
    llm_model = Column(String(50))  # gpt-4-turbo, addis-ai-am
    llm_tokens_used = Column(Integer)
    
    # Timestamp
    created_at = Column(DateTime, default=datetime.utcnow)
```

---

## Step 5: Create Database Utilities

### üíª Create `database/db.py`

```python
"""
Database connection utilities.

Provides:
- Database engine creation
- Session management with context manager
- Helper functions for common queries
"""

import os
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker, Session
from contextlib import contextmanager
from typing import Optional
import logging

from database.models import Base, Donor, Campaign, NGOOrganization

logger = logging.getLogger(__name__)

# Get database URL from environment
DATABASE_URL = os.getenv("DATABASE_URL")

if not DATABASE_URL:
    raise ValueError("DATABASE_URL environment variable not set!")

# Create engine
# pool_pre_ping=True: Check connection health before using
engine = create_engine(
    DATABASE_URL,
    pool_pre_ping=True,
    echo=False  # Set to True to see SQL queries (debugging)
)

# Session factory
SessionLocal = sessionmaker(
    bind=engine,
    expire_on_commit=False,
    autoflush=False
)


@contextmanager
def get_db() -> Session:
    """
    Context manager for database sessions.
    
    Usage:
        with get_db() as db:
            donor = db.query(Donor).filter_by(id=1).first()
            # Session auto-commits on success, rolls back on error
    
    Benefits:
    - Automatic commit on success
    - Automatic rollback on exception
    - Ensures connection is closed
    """
    db = SessionLocal()
    try:
        yield db
        db.commit()
    except Exception as e:
        db.rollback()
        logger.error(f"Database error: {e}")
        raise
    finally:
        db.close()


def create_tables():
    """
    Create all tables in database.
    
    WARNING: Only use in development!
    Production should use Alembic migrations.
    """
    Base.metadata.create_all(bind=engine)
    logger.info("Database tables created")


def drop_tables():
    """
    Drop all tables in database.
    
    WARNING: DESTRUCTIVE! Only use in testing.
    """
    Base.metadata.drop_all(bind=engine)
    logger.warning("All database tables dropped")


# ============================================
# Helper Functions for Common Queries
# ============================================

def get_donor_by_phone(phone: str) -> Optional[Donor]:
    """Get donor by phone number."""
    with get_db() as db:
        return db.query(Donor).filter_by(phone_number=phone).first()


def get_donor_by_telegram_id(telegram_id: str) -> Optional[Donor]:
    """Get donor by Telegram user ID."""
    with get_db() as db:
        return db.query(Donor).filter_by(telegram_user_id=telegram_id).first()


def get_donor_by_whatsapp(whatsapp_number: str) -> Optional[Donor]:
    """Get donor by WhatsApp number."""
    with get_db() as db:
        return db.query(Donor).filter_by(whatsapp_number=whatsapp_number).first()


def get_active_campaigns():
    """Get all active campaigns."""
    with get_db() as db:
        return db.query(Campaign).filter_by(status="active").all()


def get_campaign_by_id(campaign_id: int) -> Optional[Campaign]:
    """Get campaign by ID."""
    with get_db() as db:
        return db.query(Campaign).filter_by(id=campaign_id).first()
```

---

## Step 6: Create FastAPI Application

### üìö Background: FastAPI Basics

**Why FastAPI:**
- **Async Support:** Handle 1000+ concurrent users
- **Auto Documentation:** Swagger UI at `/docs`
- **Type Validation:** Pydantic models catch errors early
- **Fast:** Performance comparable to Node.js/Go

### üíª Create `main.py`

```python
"""
TrustVoice FastAPI Application

Entry point for the voice-first donation platform.
"""

import os
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from dotenv import load_dotenv
import logging

# Load environment variables
load_dotenv()

# Configure logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# Create FastAPI app
app = FastAPI(
    title="TrustVoice API",
    description="Voice-first donation platform with blockchain receipts",
    version="1.0.0"
)

# CORS configuration (allow web dashboard to call API)
ALLOWED_ORIGINS = os.getenv("ALLOWED_ORIGINS", "http://localhost:3000").split(",")
app.add_middleware(
    CORSMiddleware,
    allow_origins=ALLOWED_ORIGINS,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)


# ============================================
# Health Check Endpoint
# ============================================

@app.get("/health")
async def health_check():
    """
    Health check endpoint for monitoring.
    
    Returns server status and basic info.
    Used by:
    - Monitoring services (UptimeRobot, Pingdom)
    - Load balancers
    - Deployment systems (Railway, Render)
    """
    return {
        "status": "healthy",
        "service": "TrustVoice API",
        "version": "1.0.0",
        "environment": os.getenv("APP_ENV", "development")
    }


@app.get("/")
async def root():
    """Root endpoint with API information."""
    return {
        "message": "Welcome to TrustVoice API",
        "documentation": "/docs",
        "health": "/health"
    }


# ============================================
# TODO: Include routers (Lab 2+)
# ============================================
# from voice.routers import ivr, telegram, whatsapp
# from payments.routers import stripe_router, paypal_router
#
# app.include_router(ivr.router, prefix="/voice/ivr", tags=["IVR"])
# app.include_router(telegram.router, prefix="/voice/telegram", tags=["Telegram"])
# app.include_router(whatsapp.router, prefix="/voice/whatsapp", tags=["WhatsApp"])
# app.include_router(stripe_router, prefix="/payments/stripe", tags=["Stripe"])


# ============================================
# Startup/Shutdown Events
# ============================================

@app.on_event("startup")
async def startup_event():
    """Run on application startup."""
    logger.info("TrustVoice API starting up...")
    logger.info(f"Environment: {os.getenv('APP_ENV')}")
    logger.info(f"Database: {os.getenv('DATABASE_URL', 'Not configured')[:30]}...")
    
    # TODO: Initialize database connection pool
    # TODO: Connect to Redis
    # TODO: Warm up AI models


@app.on_event("shutdown")
async def shutdown_event():
    """Run on application shutdown."""
    logger.info("TrustVoice API shutting down...")
    # TODO: Close database connections
    # TODO: Close Redis connection
    # TODO: Cleanup resources


# ============================================
# Run Server (Development Only)
# ============================================

if __name__ == "__main__":
    import uvicorn
    
    port = int(os.getenv("APP_PORT", 8000))
    host = os.getenv("APP_HOST", "0.0.0.0")
    
    logger.info(f"Starting server on {host}:{port}")
    
    uvicorn.run(
        "main:app",
        host=host,
        port=port,
        reload=True,  # Auto-reload on code changes (dev only!)
        log_level="info"
    )
```

---

## Step 7: Test the Setup

### üß™ Verification Steps

```bash
# Ensure venv is activated
source venv/bin/activate

# Run the FastAPI server
python main.py
```

**Expected Output:**
```
INFO:     Will watch for changes in these directories: ['/Users/manu/Trust-Voice']
INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
INFO:     Started reloader process [12345] using StatReload
INFO:     Started server process [12346]
INFO:     Waiting for application startup.
TrustVoice API starting up...
INFO:     Application startup complete.
```

### Test Endpoints

**Open browser:**
- http://localhost:8000 ‚Üí Root endpoint
- http://localhost:8000/health ‚Üí Health check
- http://localhost:8000/docs ‚Üí Swagger UI (auto-generated API docs!)

**Using curl:**
```bash
# Test health endpoint
curl http://localhost:8000/health

# Expected response:
{
  "status": "healthy",
  "service": "TrustVoice API",
  "version": "1.0.0",
  "environment": "development"
}
```

---

## Step 8: Initialize Database

### üíª Create Database Initialization Script

```python
# Create init_db.py
"""
Initialize database tables.

Run this script to create all tables in the database.
"""

from database.db import create_tables, engine
from database.models import Base
import logging

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

if __name__ == "__main__":
    print("Creating database tables...")
    try:
        create_tables()
        print("\n‚úÖ Tables created successfully!")
        
        # Print table names
        print("\nTables:")
        for table_name in Base.metadata.tables.keys():
            print(f"  - {table_name}")
    except Exception as e:
        print(f"\n‚ùå Error creating tables: {e}")
        raise
```

### Run Database Initialization

```bash
# Load environment variables and create tables
export $(cat .env | grep -v '^#' | xargs)
python init_db.py
```

**Expected Output:**
```
Creating database tables...
INFO:database.db:Database tables created

‚úÖ Tables created successfully!

Tables:
  - donors
  - ngo_organizations
  - campaigns
  - campaign_context
  - donations
  - impact_verifications
  - conversation_logs
```

---

## Step 9: Test the Application

### üß™ Create Test Suite

**Why Testing:**
- Catch bugs early
- Document expected behavior
- Ensure code quality
- Enable refactoring confidence

### üíª Create Basic Tests

First, we need to fix a pytest issue with web3. The web3 library includes a pytest plugin that conflicts with eth_typing versions. We'll remove web3 for now (Lab 1-7 don't need it) and add it back in Lab 8 when we build blockchain features.

```bash
# Remove web3 temporarily (will add back in Lab 8)
pip uninstall -y web3
pip freeze > requirements.txt
```

### Create Pytest Configuration

Create `pytest.ini`:
```ini
[pytest]
# Pytest configuration for TrustVoice

# Disable web3 pytest plugin (causes import errors, we'll test blockchain separately)
addopts = -p no:pytest-ethereum

# Test discovery
python_files = test_*.py
python_classes = Test*
python_functions = test_*

# Output
console_output_style = progress
log_cli = false
log_cli_level = INFO

# Markers for organizing tests
markers =
    unit: Unit tests (fast, no external dependencies)
    integration: Integration tests (database, APIs)
    e2e: End-to-end tests (full user flows)
    slow: Tests that take longer to run
```

### Create Test Files

**File 1: `tests/test_api.py`** (Comprehensive pytest tests)

```python
"""
Basic tests for TrustVoice API endpoints.

Tests:
- Health check endpoint
- Database connection
- Model creation
"""

import pytest
from fastapi.testclient import TestClient
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
import os

# Import app
from main import app

# Test client
client = TestClient(app)


class TestHealthEndpoints:
    """Test basic health and info endpoints."""
    
    def test_root_endpoint(self):
        """Test root endpoint returns welcome message."""
        response = client.get("/")
        assert response.status_code == 200
        data = response.json()
        assert "message" in data
        assert "TrustVoice" in data["message"]
    
    def test_health_check(self):
        """Test health endpoint returns healthy status."""
        response = client.get("/health")
        assert response.status_code == 200
        data = response.json()
        assert data["status"] == "healthy"
        assert data["service"] == "TrustVoice API"
        assert data["version"] == "1.0.0"
        assert "environment" in data


class TestDatabaseModels:
    """Test database model creation."""
    
    def test_donor_model_creation(self):
        """Test Donor model can be imported and has correct fields."""
        from database.models import Donor
        
        # Check key fields exist
        assert hasattr(Donor, 'id')
        assert hasattr(Donor, 'phone_number')
        assert hasattr(Donor, 'telegram_user_id')
        assert hasattr(Donor, 'preferred_language')
        assert hasattr(Donor, 'total_donated_usd')
    
    def test_campaign_model_creation(self):
        """Test Campaign model can be imported and has correct fields."""
        from database.models import Campaign
        
        assert hasattr(Campaign, 'id')
        assert hasattr(Campaign, 'ngo_id')
        assert hasattr(Campaign, 'title')
        assert hasattr(Campaign, 'goal_amount_usd')
        assert hasattr(Campaign, 'raised_amount_usd')
        assert hasattr(Campaign, 'status')
    
    def test_donation_model_creation(self):
        """Test Donation model can be imported and has correct fields."""
        from database.models import Donation
        
        assert hasattr(Donation, 'id')
        assert hasattr(Donation, 'donor_id')
        assert hasattr(Donation, 'campaign_id')
        assert hasattr(Donation, 'amount_usd')
        assert hasattr(Donation, 'payment_method')
        assert hasattr(Donation, 'status')


class TestDatabaseConnection:
    """Test database connection (requires DATABASE_URL)."""
    
    def test_database_url_exists(self):
        """Test that DATABASE_URL is configured."""
        from database.db import DATABASE_URL
        assert DATABASE_URL is not None
        assert "postgresql" in DATABASE_URL
    
    def test_engine_creation(self):
        """Test that database engine can be created."""
        from database.db import engine
        assert engine is not None


class TestEnvironmentVariables:
    """Test environment configuration."""
    
    def test_required_env_vars(self):
        """Test that critical environment variables are set."""
        from dotenv import load_dotenv
        load_dotenv()
        
        # These should exist (even if placeholder values)
        assert os.getenv("DATABASE_URL") is not None
        assert os.getenv("APP_ENV") is not None
        assert os.getenv("APP_PORT") is not None


if __name__ == "__main__":
    # Run tests
    pytest.main([__file__, "-v"])
```

**File 2: `tests/test_basic.py`** (Simple direct tests, no pytest needed)

```python
"""
Simple direct tests without pytest framework.
Useful for quick validation without pytest overhead.
"""

import sys
import os
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from fastapi.testclient import TestClient
from main import app
from database.models import Donor, Campaign, Donation
from dotenv import load_dotenv

# Load environment
load_dotenv()

# Test client
client = TestClient(app)

def test_health_endpoint():
    """Test health endpoint."""
    print("Testing /health endpoint...")
    response = client.get("/health")
    assert response.status_code == 200
    data = response.json()
    assert data["status"] == "healthy"
    assert data["service"] == "TrustVoice API"
    print("‚úÖ Health endpoint test passed")

def test_root_endpoint():
    """Test root endpoint."""
    print("Testing / endpoint...")
    response = client.get("/")
    assert response.status_code == 200
    data = response.json()
    assert "TrustVoice" in data["message"]
    print("‚úÖ Root endpoint test passed")

def test_models_exist():
    """Test that models can be imported."""
    print("Testing database models...")
    
    assert hasattr(Donor, 'id')
    assert hasattr(Donor, 'phone_number')
    print("  ‚úì Donor model OK")
    
    assert hasattr(Campaign, 'title')
    assert hasattr(Campaign, 'goal_amount_usd')
    print("  ‚úì Campaign model OK")
    
    assert hasattr(Donation, 'amount_usd')
    assert hasattr(Donation, 'status')
    print("  ‚úì Donation model OK")
    
    print("‚úÖ All models test passed")

def test_environment_variables():
    """Test environment variables are loaded."""
    print("Testing environment variables...")
    
    assert os.getenv("DATABASE_URL") is not None
    assert "postgresql" in os.getenv("DATABASE_URL")
    assert os.getenv("APP_ENV") == "development"
    
    print("‚úÖ Environment variables test passed")

def test_database_connection():
    """Test database connection."""
    print("Testing database connection...")
    from database.db import engine, DATABASE_URL
    
    assert DATABASE_URL is not None
    assert engine is not None
    
    print("‚úÖ Database connection test passed")

if __name__ == "__main__":
    print("\n" + "="*50)
    print("   TrustVoice Lab 1 Test Suite")
    print("="*50 + "\n")
    
    tests = [
        test_health_endpoint,
        test_root_endpoint,
        test_models_exist,
        test_environment_variables,
        test_database_connection
    ]
    
    passed = 0
    failed = 0
    
    for test in tests:
        try:
            test()
            passed += 1
        except AssertionError as e:
            print(f"‚ùå {test.__name__} failed: {e}")
            failed += 1
        except Exception as e:
            print(f"‚ùå {test.__name__} error: {e}")
            failed += 1
    
    print("\n" + "="*50)
    print(f"Results: {passed} passed, {failed} failed")
    print("="*50 + "\n")
    
    sys.exit(0 if failed == 0 else 1)
```

### Run Tests

**Option 1: Run with pytest (full test framework)**

```bash
# Load environment and run all tests
export $(cat .env | grep -v '^#' | xargs)
pytest tests/test_api.py -v
```

**Expected Output:**
```
========================= test session starts =========================
collected 8 items

tests/test_api.py::TestHealthEndpoints::test_root_endpoint PASSED [ 12%]
tests/test_api.py::TestHealthEndpoints::test_health_check PASSED [ 25%]
tests/test_api.py::TestDatabaseModels::test_donor_model_creation PASSED [ 37%]
tests/test_api.py::TestDatabaseModels::test_campaign_model_creation PASSED [ 50%]
tests/test_api.py::TestDatabaseModels::test_donation_model_creation PASSED [ 62%]
tests/test_api.py::TestDatabaseConnection::test_database_url_exists PASSED [ 75%]
tests/test_api.py::TestDatabaseConnection::test_engine_creation PASSED [ 87%]
tests/test_api.py::TestEnvironmentVariables::test_required_env_vars PASSED [100%]

==================== 8 passed, 5 warnings in 0.39s ====================
```

**Option 2: Run simple tests (faster, no pytest)**

```bash
python tests/test_basic.py
```

**Expected Output:**
```
==================================================
   TrustVoice Lab 1 Test Suite
==================================================

Testing /health endpoint...
‚úÖ Health endpoint test passed
Testing / endpoint...
‚úÖ Root endpoint test passed
Testing database models...
  ‚úì Donor model OK
  ‚úì Campaign model OK
  ‚úì Donation model OK
‚úÖ All models test passed
Testing environment variables...
‚úÖ Environment variables test passed
Testing database connection...
‚úÖ Database connection test passed

==================================================
Results: 5 passed, 0 failed
==================================================
```

---

## Step 10: Version Control with Git

### üìö Background: Why Git?

**Git Best Practices:**
- Commit early, commit often
- Write meaningful commit messages
- Never commit secrets (.env file)
- Use .gitignore properly

### üíª Initialize Git Repository

```bash
# Initialize git
git init

# Add .gitignore first (prevents committing secrets)
git add .gitignore

# Add all project files
git add .

# Check what's being committed (verify .env is NOT listed!)
git status
```

**Expected Output:**
```
On branch main

No commits yet

Changes to be committed:
  (use "git rm --cached <file>..." to unstage)
        new file:   .env.example
        new file:   .gitignore
        new file:   blockchain/__init__.py
        new file:   database/__init__.py
        new file:   database/db.py
        new file:   database/migrations/__init__.py
        new file:   database/models.py
        new file:   documentation/LAB_01_PROJECT_SETUP.md
        new file:   init_db.py
        new file:   main.py
        new file:   payments/__init__.py
        new file:   pytest.ini
        new file:   requirements.txt
        new file:   tests/__init__.py
        new file:   tests/test_api.py
        new file:   tests/test_basic.py
        ... (more files)
```

**IMPORTANT:** Verify that `.env` is **NOT** in the list! If you see it, run:
```bash
git rm --cached .env
```

### First Commit

```bash
git commit -m "Lab 1: Initial project setup

- Created virtual environment with all dependencies
- Set up project structure (database, voice, payments, blockchain)
- Configured FastAPI application with health endpoints
- Created 7 SQLAlchemy models (donors, campaigns, donations, etc.)
- Initialized Neon PostgreSQL database
- Added comprehensive documentation (Lab 1 + specs)
- Configured environment variables (.env protected by .gitignore)
- Added test suite with pytest
- Server running on port 8001"
```

### Commit Tests

```bash
git add tests/ pytest.ini
git commit -m "Add test suite and pytest configuration

- Added pytest.ini configuration
- Created test_api.py with 8 comprehensive tests
- Created test_basic.py for simple direct testing
- Removed web3 temporarily (will add back in Lab 8)
- All tests passing: endpoints, models, database, environment

Test Results: 8 passed, 0 failed ‚úÖ"
```

### View Commit History

```bash
git log --oneline --decorate
```

**Expected Output:**
```
2a485d8 (HEAD -> main) Add test suite and pytest configuration
1aef64b Lab 1: Initial project setup
```

---

## ‚úÖ Lab 1 Completion Checklist

Verify you have completed all steps:

- [ ] Virtual environment created and activated (`venv/`)
- [ ] All project directories created (use `find . -type d` to verify)
- [ ] All `__init__.py` files created
- [ ] Dependencies installed (`pip list` shows fastapi, sqlalchemy, etc.)
- [ ] `requirements.txt` generated (web3 removed temporarily)
- [ ] `.env` file created with actual API keys
- [ ] `.env.example` created (safe to commit)
- [ ] `.gitignore` configured properly
- [ ] `database/models.py` created with all 7 models
- [ ] `database/db.py` created with utilities
- [ ] `main.py` created and runs successfully
- [ ] Database tables created in Neon PostgreSQL
- [ ] Can access http://localhost:8001/health (or your port)
- [ ] Health check returns `{"status": "healthy"}`
- [ ] `pytest.ini` configured
- [ ] Test files created (`test_api.py`, `test_basic.py`)
- [ ] All tests passing (8 pytest tests)
- [ ] Git repository initialized
- [ ] `.env` NOT committed (verify with `git status`)
- [ ] Initial commits made

**Test Your Setup:**

```bash
# 1. Server is running
curl http://localhost:8001/health

# 2. Tests pass
export $(cat .env | grep -v '^#' | xargs)
pytest tests/test_api.py -v

# 3. Git is clean (no uncommitted secrets)
git status

# 4. View commits
git log --oneline
```

---

## üìö What We Accomplished

**Project Structure:** ‚úÖ
- Complete directory tree ready to be filled
- Modular design (voice, payments, blockchain separate)
- All Python packages properly initialized

**Virtual Environment:** ‚úÖ
- Isolated dependencies from system Python
- `requirements.txt` for reproducible installs
- Ready for team collaboration

**Database Foundation:** ‚úÖ
- 7 SQLAlchemy models defined
- Relationships configured (donors ‚Üí donations ‚Üí campaigns)
- Helper functions for common queries
- Ready for Alembic migrations (Lab 2)

**FastAPI Server:** ‚úÖ
- Runs on http://localhost:8000
- Auto-generated API docs at `/docs`
- Health check endpoint
- Structured for adding routers

**Configuration:** ‚úÖ
- Environment variables in `.env` (secure)
- `.gitignore` prevents committing secrets
- Logging configured
- CORS enabled for web dashboard

---

## üöÄ Next Steps (Lab 2)

In the next lab, we'll:
1. Set up Alembic migrations for database versioning
2. Create campaign and donor management APIs
3. Add first database entries (seed data)
4. Build admin endpoints for NGOs
5. Test CRUD operations
6. Add more comprehensive integration tests

---

## üí° Key Takeaways

**Virtual Environment Best Practices:**
- ‚úÖ Always activate before working: `source venv/bin/activate`
- ‚úÖ Keep `requirements.txt` updated: `pip freeze > requirements.txt`
- ‚úÖ Never commit `venv/` folder to Git
- ‚úÖ Deactivate when done: `deactivate`

**Directory Structure:**
- Modular design = easier to maintain
- Clear separation of concerns
- Scales as project grows
- Easy for new developers to navigate

**Environment Variables:**
- NEVER commit API keys to Git
- Use `.env` for secrets, `.env.example` for template
- Load with `python-dotenv` in development
- Production: Use Railway/Render secrets management

**Database Models:**
- Define relationships upfront (prevents refactoring later)
- Add indexes on frequently queried fields (phone_number, telegram_id)
- Use timestamps for debugging
- SQLAlchemy handles SQL generation (write less code)

**Testing:**
- Write tests as you build features
- Pytest for comprehensive testing
- Simple direct tests for quick validation
- Test environment configuration early

**Git Workflow:**
- Commit early, commit often
- Write meaningful commit messages
- Always verify `.env` is not staged
- Use `.gitignore` effectively

---

## üéì Common Gotchas

### Problem: `ModuleNotFoundError: No module named 'fastapi'`

**Cause:** Virtual environment not activated or dependencies not installed

**Solution:**
```bash
source venv/bin/activate
pip install -r requirements.txt
```

---

### Problem: `ImportError: cannot import name 'Donor' from 'database.models'`

**Cause:** Missing `__init__.py` files

**Solution:**
```bash
touch database/__init__.py
touch voice/__init__.py
# Ensure all package directories have __init__.py
```

---

### Problem: `sqlalchemy.exc.OperationalError: could not connect to server`

**Cause:** Database URL incorrect or PostgreSQL not running

**Solution:**
```bash
# Check DATABASE_URL in .env
cat .env | grep DATABASE_URL

# Verify Neon database is accessible
# Or update .env with correct Neon URL
```

---

### Problem: FastAPI docs not showing at /docs

**Cause:** Wrong port or server not running

**Solution:**
```bash
# Check which port you configured
cat .env | grep APP_PORT

# Start server
python main.py

# Access at correct URL
# http://localhost:8001/docs (if APP_PORT=8001)
```

---

### Problem: Pytest import errors with web3

**Cause:** web3 pytest plugin conflicts with eth_typing

**Solution:**
```bash
# Already fixed in Lab 1!
# web3 removed temporarily (will add back in Lab 8)
# pytest.ini configured to disable ethereum plugin

# If you see the error:
pip uninstall -y web3
pytest tests/test_api.py -v
```

---

### Problem: PORT already in use

**Cause:** Another application using port 8000 or 8001

**Solution:**
```bash
# Change port in .env
# Update APP_PORT to different value (e.g., 8002)
nano .env

# Update ALLOWED_ORIGINS to match
# Then restart server
python main.py
```

---

## üîí Security Considerations

**Environment Variables:**
- ‚úÖ Never commit `.env` to Git
- ‚úÖ Rotate API keys regularly
- ‚úÖ Use different keys for dev/staging/prod
- ‚úÖ Restrict API key permissions (e.g., Stripe test keys for development)

**Database:**
- ‚úÖ Use connection pooling (prevents exhausting connections)
- ‚úÖ Never log sensitive data (donor phone numbers, payment info)
- ‚úÖ Implement soft deletes (set `is_active=False` instead of DELETE)

**Dependencies:**
- ‚úÖ Keep `requirements.txt` updated
- ‚úÖ Run `pip audit` to check for vulnerabilities (when available)
- ‚úÖ Use specific versions in production (`fastapi==0.109.0`, not `fastapi>=0.109.0`)

**Testing:**
- ‚úÖ Don't use production API keys in tests
- ‚úÖ Use test mode for Stripe/Twilio
- ‚úÖ Clean up test data after tests run

---

## üí∞ Cost Considerations (So Far)

**Development (Lab 1):**
- Virtual environment: Free
- PostgreSQL (Neon): Free tier (512 MB)
- FastAPI: Free (open source)
- Python: Free
- **Total: $0/month**

**Production (After Deployment - Lab 10):**
- Neon PostgreSQL: $20/month (paid tier for production)
- Railway/Render: $50/month (basic tier)
- Redis Cloud: $10/month (basic tier)
- **Total: ~$80/month** (before API costs)

**API Costs (Will add as we build):**
- OpenAI GPT-4: ~$0.20 per conversation
- Twilio Voice: ~$0.40 per minute
- Stripe: 2.9% + $0.30 per transaction
- (More details in Labs 3-5)

Lab 1 is completely free to run locally!

---

## üìù Summary

**What We Built:**
- Complete project structure with 9 directories
- Virtual environment with 100+ dependencies
- 7 database models (donors, campaigns, donations, etc.)
- FastAPI server with health check and auto-docs
- Proper environment variable management
- Security best practices (.gitignore, .env)
- Comprehensive test suite (8 tests passing)
- Git repository with proper commits

**Time Investment:** 2-3 hours  
**Lines of Code:** ~800 lines  
**Cost:** $0 (local development)  
**Test Coverage:** 8 tests passing ‚úÖ

**Foundation Status:** ‚úÖ SOLID & PRODUCTION-READY

You now have a production-ready project structure. All future labs will fill in the routers, AI logic, payment integration, and blockchain components.

---

## üìã Why This Design?

Let's examine the key architectural decisions we made in Lab 1 and understand why they matter for building a production-ready NGO donation platform.

### Decision 1: Virtual Environment vs System Python

**What We Chose:** Virtual environment (`venv`)

**Why?**
- **Dependency Isolation:** Each project gets its own dependencies without conflicts
- **Version Control:** Pin exact versions (FastAPI==0.104.1) for reproducible deployments
- **Team Consistency:** Everyone runs the same versions regardless of their system Python
- **Production Parity:** Development matches production environment exactly

**Alternatives Considered:**
- **System Python:** Simpler but causes dependency conflicts across projects
- **Docker:** More isolated but adds complexity for initial development
- **Poetry/Pipenv:** Better dependency management but requires learning new tools

**Trade-offs:**
- ‚úÖ Clean isolation and reproducibility
- ‚ùå Extra activation step (`source venv/bin/activate`)
- ‚úÖ Standard Python tooling, no new dependencies
- ‚ùå Larger disk usage (separate copy per project)

**When to Reconsider:** For containerized deployments (Docker), skip venv in favor of container isolation

---

### Decision 2: PostgreSQL vs NoSQL Databases

**What We Chose:** PostgreSQL (relational database)

**Why?**
- **ACID Transactions:** Critical for financial data (donations must be atomic)
- **Data Integrity:** Foreign keys prevent orphaned records (donors without campaigns)
- **Complex Queries:** JOIN operations for campaign analytics and donor history
- **JSON Support:** Modern PostgreSQL supports JSON fields (best of both worlds)
- **Proven for Finance:** Banks and payment systems use relational databases

**Alternatives Considered:**
- **MongoDB (NoSQL):** Flexible schema but no built-in transactions or foreign keys
- **MySQL:** Similar to PostgreSQL but weaker JSON support and less extensible
- **SQLite:** Great for development but not production-grade for concurrent writes

**Trade-offs:**
- ‚úÖ Data consistency guaranteed (no partial donations)
- ‚ùå Schema changes require migrations (more upfront planning)
- ‚úÖ Rich querying capabilities (aggregations, JOINs)
- ‚ùå Slightly more setup than SQLite

**Real-World Impact:** A donor makes a $1000 donation. If the payment succeeds but the database write fails, PostgreSQL transactions ensure we can rollback the payment or retry atomically‚Äîno money lost, no orphaned records.

---

### Decision 3: SQLAlchemy ORM vs Raw SQL

**What We Chose:** SQLAlchemy ORM with declarative models

**Why?**
- **Type Safety:** IDEs autocomplete fields, catch typos before runtime
- **Migration Management:** Alembic tracks schema changes automatically
- **Security:** ORM prevents SQL injection by default (parameterized queries)
- **Readability:** `campaign.name` is clearer than `row[3]`
- **Relationships:** Define `campaign.donations` once, query anywhere

**Alternatives Considered:**
- **Raw SQL:** Faster for complex queries but error-prone and no type safety
- **Django ORM:** Excellent but tightly coupled to Django framework
- **Tortoise ORM:** Async-first but smaller community and fewer resources

**Trade-offs:**
- ‚úÖ Safer code (type checking, automatic escaping)
- ‚ùå Learning curve for advanced queries
- ‚úÖ Easier refactoring (rename field in one place)
- ‚ùå Slight performance overhead (usually negligible)

**Code Comparison:**

```python
# Raw SQL (error-prone)
cursor.execute("SELECT * FROM campaigns WHERE id = %s", (campaign_id,))
row = cursor.fetchone()
name = row[2]  # Which column is this? Easy to break.

# SQLAlchemy ORM (safe)
campaign = db.query(Campaign).filter(Campaign.id == campaign_id).first()
name = campaign.name  # IDE autocompletes, type-checked
```

---

### Decision 4: Environment Variables (.env) vs Config Files

**What We Chose:** `.env` file with `python-dotenv` for secrets

**Why?**
- **Security:** Never commit secrets to Git (`.env` in `.gitignore`)
- **Environment-Specific:** Different values for dev/staging/production
- **12-Factor App:** Industry standard for cloud-native applications
- **Easy Rotation:** Change password without modifying code

**Alternatives Considered:**
- **Hardcoded Values:** Convenient but MASSIVE security risk
- **JSON Config Files:** Works but easy to accidentally commit secrets
- **Vault/Secrets Manager:** Better for production but overkill for development

**Trade-offs:**
- ‚úÖ Secure by default (not in version control)
- ‚ùå Manual setup required (copy `.env.example` to `.env`)
- ‚úÖ Standard across languages (Node.js, Python, Ruby all use .env)
- ‚ùå Local-only (production needs secrets management service)

**Security Impact:**
```
# BAD - Committed to Git, visible in history forever
DATABASE_URL = "postgresql://user:ACTUAL_PASSWORD@localhost/db"

# GOOD - In .env (ignored by Git), rotatable
DATABASE_URL = os.getenv("DATABASE_URL")
```

---

### Decision 5: Domain-Based Directory Structure vs Flat

**What We Chose:** Domain-based structure (`/models`, `/routers`, `/services`)

**Why?**
- **Scalability:** Add new domains (payments, AI) without refactoring
- **Team Collaboration:** Multiple devs work on different routers without conflicts
- **Clear Boundaries:** Models define data, routers handle HTTP, services contain logic
- **Testing:** Mock services without touching routers, test models independently

**Alternatives Considered:**
- **Flat Structure:** All files in one folder (only works for tiny projects)
- **Feature-Based:** Group by feature (`/campaigns`, `/donors`) instead of type
- **Monolith:** One giant `app.py` file (maintainability nightmare)

**Trade-offs:**
- ‚úÖ Easy to locate files (`models/campaign.py` for Campaign model)
- ‚ùå More folders to navigate
- ‚úÖ Clean separation of concerns (models don't import routers)
- ‚ùå Requires discipline (don't put business logic in routers)

**Structure Comparison:**

```
# Our Choice (Scalable)
ngo_platform/
  models/          # Data definitions only
  routers/         # HTTP endpoints only
  services/        # Business logic only
  
# Alternative (Feature-based)
ngo_platform/
  campaigns/       # All campaign code
    model.py
    router.py
    service.py
```

Both work! We chose domain-based because it's more common in FastAPI projects and scales better when features share code (e.g., both campaigns and donations need payment processing).

---

## üöÄ Production Considerations

Lab 1 set up a development environment. Here's what changes when you deploy to production:

### Security Checklist

**Environment Variables:**
```bash
# ‚ùå Development (.env file)
DATABASE_URL=postgresql://user:dev_password@localhost/ngo_db
SECRET_KEY=dev-secret-key-not-secure

# ‚úÖ Production (Secrets manager)
DATABASE_URL=postgresql://user:$(aws secretsmanager get-secret-value ...)
SECRET_KEY=$(openssl rand -hex 32)
```

**Database Credentials:**
- Use AWS Secrets Manager, Azure Key Vault, or Google Secret Manager
- Rotate passwords every 90 days
- Limit database user permissions (no DROP TABLE in production)

**Dependencies:**
```bash
# Scan for vulnerabilities before deployment
pip install safety
safety check --file requirements.txt

# Keep dependencies updated
pip list --outdated
```

**HTTPS Only:**
```python
# Force HTTPS in production
if os.getenv("ENVIRONMENT") == "production":
    app.add_middleware(
        HTTPSRedirectMiddleware
    )
```

---

### Scaling Considerations

**Database Connection Pooling:**
```python
# Development (SQLite, no pooling needed)
engine = create_engine("sqlite:///./test.db")

# Production (PostgreSQL with pooling)
engine = create_engine(
    os.getenv("DATABASE_URL"),
    pool_size=20,           # Max concurrent connections
    max_overflow=10,        # Extra connections when busy
    pool_timeout=30,        # Wait 30s for available connection
    pool_recycle=3600,      # Reconnect every hour (avoids stale connections)
)
```

**Environment-Specific Settings:**
```python
# config.py
class Settings:
    def __init__(self):
        self.env = os.getenv("ENVIRONMENT", "development")
        self.debug = self.env == "development"
        self.database_url = os.getenv("DATABASE_URL")
        
        if self.env == "production":
            self.pool_size = 50
            self.log_level = "ERROR"
        else:
            self.pool_size = 5
            self.log_level = "DEBUG"

settings = Settings()
```

**Performance Monitoring:**
```python
# Add request timing
import time
from fastapi import Request

@app.middleware("http")
async def add_process_time_header(request: Request, call_next):
    start_time = time.time()
    response = await call_next(request)
    process_time = time.time() - start_time
    response.headers["X-Process-Time"] = str(process_time)
    return response
```

---

### Deployment Checklist

Before deploying to production, verify:

**Infrastructure:**
- [ ] PostgreSQL database provisioned (AWS RDS, Heroku Postgres, DigitalOcean Managed DB)
- [ ] Database backups configured (daily, retained for 30 days)
- [ ] SSL certificate installed (Let's Encrypt or cloud provider)
- [ ] Domain name configured with DNS (e.g., api.trustvoice.org)

**Application:**
- [ ] Environment variables set in production (not .env file)
- [ ] `DEBUG=False` in production
- [ ] CORS configured (only allow your frontend domain)
- [ ] Health check endpoint added (`GET /health`)
- [ ] Logging configured (send to CloudWatch, Datadog, or Sentry)

**Database:**
- [ ] Migrations applied (`alembic upgrade head`)
- [ ] Indexes created for frequently queried columns
- [ ] Database user has minimal permissions (no DROP, GRANT)

**Testing:**
- [ ] All tests passing (`pytest`)
- [ ] Load testing completed (can handle expected traffic)
- [ ] Security scan passed (`safety check`)

**Monitoring:**
- [ ] Error tracking enabled (Sentry, Rollbar)
- [ ] Uptime monitoring (UptimeRobot, Pingdom)
- [ ] Performance monitoring (New Relic, Datadog)

---

### Cost Optimization

**Development (Lab 1):** $0
- Local PostgreSQL: Free
- No hosting: Free

**MVP Production:** $15-50/month
- **Database:** Heroku Postgres Hobby ($9/month) or DigitalOcean Managed DB ($15/month)
- **Hosting:** Heroku Dyno ($7/month) or Railway ($5/month)
- **Domain:** Namecheap ($10/year)
- **SSL:** Let's Encrypt (Free)

**Scaling (1000+ users):** $100-300/month
- **Database:** AWS RDS db.t3.medium ($50/month)
- **Hosting:** AWS Fargate or DigitalOcean App Platform ($50-100/month)
- **CDN:** Cloudflare (Free) or AWS CloudFront ($20/month)
- **Monitoring:** Sentry ($26/month for small team)
- **Backups:** AWS S3 ($5/month)

**Free Tier Options:**
- **Render:** Free PostgreSQL (expires after 90 days, good for demos)
- **Fly.io:** Free tier includes PostgreSQL and hosting
- **Supabase:** Free PostgreSQL with 500MB storage
- **Neon:** Serverless PostgreSQL free tier (1GB)

---

## üêõ Common Gotchas

Here are the issues you'll encounter in Lab 1 and how to fix them:

### Gotcha 1: Virtual Environment Not Activated

**Symptom:**
```bash
$ pip list
# Shows system packages instead of project packages
$ python main.py
ModuleNotFoundError: No module named 'fastapi'
```

**Why It Happens:** You installed packages in the venv but are running Python from system Python.

**Solution:**
```bash
# Activate venv first
source venv/bin/activate  # macOS/Linux
venv\Scripts\activate     # Windows

# Verify activation (you'll see (venv) in prompt)
(venv) $ which python
/path/to/project/venv/bin/python  # ‚úÖ Correct

# Install packages AFTER activation
(venv) $ pip install -r requirements.txt
```

**Prevention:** Add to `.bashrc` or `.zshrc`:
```bash
# Auto-activate venv when entering project directory
cd() {
    builtin cd "$@"
    if [ -f "venv/bin/activate" ]; then
        source venv/bin/activate
    fi
}
```

---

### Gotcha 2: Database Connection Fails

**Symptom:**
```
sqlalchemy.exc.OperationalError: could not connect to server: Connection refused
```

**Why It Happens:** PostgreSQL not running, wrong credentials, or wrong database name.

**Debug Steps:**
```bash
# 1. Check if PostgreSQL is running
pg_isready
# Should output: /tmp:5432 - accepting connections

# 2. Verify credentials
psql -U ngo_user -d ngo_platform
# Enter password from .env file

# 3. Check DATABASE_URL format
# Wrong: postgresql://localhost/ngo_platform (missing user)
# Right: postgresql://ngo_user:password@localhost/ngo_platform
```

**Solution:**
```bash
# macOS
brew services start postgresql@14

# Ubuntu
sudo systemctl start postgresql

# Verify database exists
psql -U postgres
postgres=# \l  # List databases
postgres=# CREATE DATABASE ngo_platform;
postgres=# CREATE USER ngo_user WITH PASSWORD 'secure_password';
postgres=# GRANT ALL PRIVILEGES ON DATABASE ngo_platform TO ngo_user;
```

---

### Gotcha 3: Import Errors (Missing `__init__.py`)

**Symptom:**
```python
from ngo_platform.models import Campaign
ModuleNotFoundError: No module named 'ngo_platform.models'
```

**Why It Happens:** Python 3.3+ doesn't require `__init__.py` for namespace packages, but SQLAlchemy and some tools still expect them.

**Solution:**
```bash
# Create __init__.py in every directory
touch ngo_platform/__init__.py
touch ngo_platform/models/__init__.py
touch ngo_platform/routers/__init__.py
touch ngo_platform/services/__init__.py
touch tests/__init__.py
```

**Even Better:** Add content to `__init__.py` to expose modules:
```python
# ngo_platform/models/__init__.py
from .campaign import Campaign
from .donor import Donor

__all__ = ["Campaign", "Donor"]
```

Now you can import:
```python
from ngo_platform.models import Campaign  # ‚úÖ Works
```

---

### Gotcha 4: Port Already in Use

**Symptom:**
```
ERROR:    [Errno 48] Address already in use
```

**Why It Happens:** Previous `uvicorn` process still running on port 8000.

**Solution:**
```bash
# Find process using port 8000
lsof -i :8000
# Output: python  12345  user  ... (LISTEN)

# Kill the process
kill -9 12345

# Or kill all Python processes (‚ö†Ô∏è use carefully)
pkill -9 python

# Alternative: Use a different port
uvicorn main:app --port 8001
```

**Prevention:** Use a process manager:
```bash
# Install
pip install watchfiles

# Run with auto-reload (stops old process automatically)
uvicorn main:app --reload
```

---

### Gotcha 5: SQLAlchemy Model Changes Not Reflected

**Symptom:**
```python
# You added a field to Campaign model
class Campaign(Base):
    __tablename__ = "campaigns"
    new_field = Column(String)  # Added this

# But querying doesn't show it
campaign = db.query(Campaign).first()
print(campaign.new_field)  # AttributeError or always None
```

**Why It Happens:** Database schema hasn't been updated (no migration run).

**Solution:**
```bash
# Create migration
alembic revision --autogenerate -m "Add new_field to Campaign"

# Apply migration
alembic upgrade head

# Verify in database
psql -U ngo_user -d ngo_platform
ngo_platform=# \d campaigns  # Describe table
# Should show new_field column
```

**Common Mistake:** Forgetting to import the model in Alembic's `env.py`:
```python
# alembic/env.py
from ngo_platform.models import Base  # ‚úÖ Must import Base
```

---

### Gotcha 6: Environment Variables Not Loading

**Symptom:**
```python
DATABASE_URL = os.getenv("DATABASE_URL")
print(DATABASE_URL)  # None
```

**Why It Happens:**
1. `.env` file not in project root
2. Forgot to call `load_dotenv()`
3. Running from wrong directory

**Solution:**
```python
# main.py (TOP of file, before any imports)
from dotenv import load_dotenv
import os

load_dotenv()  # ‚úÖ Call BEFORE accessing os.getenv()

DATABASE_URL = os.getenv("DATABASE_URL")  # Now works
```

**Debugging:**
```python
# Check where Python is looking for .env
import os
print("Current directory:", os.getcwd())
print(".env exists?", os.path.exists(".env"))

# Force load from specific path
from dotenv import load_dotenv
load_dotenv("/absolute/path/to/.env")
```

**Best Practice:**
```python
# Use with default values
DATABASE_URL = os.getenv("DATABASE_URL", "sqlite:///./fallback.db")
if not DATABASE_URL:
    raise ValueError("DATABASE_URL environment variable not set!")
```

---

## üìä Summary: Lab 1 Decisions Impact

| Decision | Development Impact | Production Impact | Cost Impact |
|----------|-------------------|-------------------|-------------|
| **Virtual Environment** | Clean dependency management | Reproducible deployments | $0 |
| **PostgreSQL** | More setup than SQLite | ACID guarantees for money | $10-50/month |
| **SQLAlchemy ORM** | Easier refactoring | Type-safe queries, migrations | $0 |
| **Environment Variables** | Manual .env setup | Secure secrets management | $0-20/month (vault) |
| **Domain Structure** | More folders to navigate | Clean separation for teams | $0 |

---

**üéâ Congratulations! Lab 1 Complete!**

You now understand not just *how* to build the foundation, but *why* we made each architectural decision. These choices will compound as we add payment processing, AI recommendations, and blockchain verification.

**Ready for Lab 2?** Let's build the campaign and donor management APIs!
