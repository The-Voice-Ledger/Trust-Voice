# TrustVoice - Lab 1: Project Setup & Foundation

**Learning Objectives:**
- Set up Python virtual environment (venv) following best practices
- Create complete project directory structure
- Configure development environment with all necessary dependencies
- Establish database connection and models
- Understand the project architecture and tech stack

**Prerequisites:**
- Python 3.11+ installed (`python3 --version`)
- PostgreSQL installed or Neon account created
- Git installed
- Code editor (VS Code recommended)
- Basic command line knowledge

**Time Estimate:** 2-3 hours  
**Difficulty:** Beginner

---

## üéØ Lab Overview: Building the Foundation

**What We're Building:**
TrustVoice is a voice-first donation platform connecting European/US donors to African NGO projects through conversational AI. Before we can build the AI, payments, and voice interfaces, we need a solid foundation.

**The Problem:**
Most development projects fail early because:
- Inconsistent directory structures lead to import confusion
- Missing dependencies cause runtime errors
- Database models aren't planned upfront
- Environment variables are hardcoded (security risk)
- No clear separation between development and production

**What This Lab Accomplishes:**
- ‚úÖ Virtual environment isolated from system Python
- ‚úÖ Complete directory structure ready to be filled
- ‚úÖ All dependencies installed and documented
- ‚úÖ Database models defined with relationships
- ‚úÖ Environment variables properly configured
- ‚úÖ Basic FastAPI server running with health check

---

## üìã System Architecture Overview

```
trustvoice/                          # Project root
‚îú‚îÄ‚îÄ venv/                            # Virtual environment (isolated)
‚îú‚îÄ‚îÄ .env                             # Environment variables (NEVER commit!)
‚îú‚îÄ‚îÄ .gitignore                       # Git exclusions
‚îú‚îÄ‚îÄ requirements.txt                 # Python dependencies
‚îú‚îÄ‚îÄ main.py                          # FastAPI application entry point
‚îú‚îÄ‚îÄ documentation/                   # All documentation & labs
‚îÇ   ‚îú‚îÄ‚îÄ LAB_01_PROJECT_SETUP.md
‚îÇ   ‚îú‚îÄ‚îÄ NGO_PLATFORM_PITCH.md
‚îÇ   ‚îú‚îÄ‚îÄ NGO_PLATFORM_TECHNICAL_SPEC.md
‚îÇ   ‚îî‚îÄ‚îÄ NGO_PLATFORM_DEVELOPMENT_PROMPT.md
‚îú‚îÄ‚îÄ database/                        # Database layer
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ models.py                    # SQLAlchemy models
‚îÇ   ‚îú‚îÄ‚îÄ db.py                        # Database utilities
‚îÇ   ‚îî‚îÄ‚îÄ migrations/                  # Alembic migrations
‚îÇ       ‚îî‚îÄ‚îÄ (generated by alembic)
‚îú‚îÄ‚îÄ voice/                           # Voice/chat interface layer
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ routers/                     # API route handlers
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ivr.py                   # Twilio voice calls
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ telegram.py              # Telegram bot
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ whatsapp.py              # WhatsApp messages
‚îÇ   ‚îú‚îÄ‚îÄ ai/                          # AI/ML components
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ conversation_manager.py  # Multi-turn dialogue
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ language_router.py       # Route by user language
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ intent_classifier.py     # Detect user intents
‚îÇ   ‚îú‚îÄ‚îÄ asr/                         # Speech recognition
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ asr_handler.py           # Whisper + local models
‚îÇ   ‚îî‚îÄ‚îÄ tasks/                       # Async background tasks
‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
‚îÇ       ‚îî‚îÄ‚îÄ celery_tasks.py
‚îú‚îÄ‚îÄ payments/                        # Payment processing
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ routers/                     
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ stripe_router.py         # Stripe integration
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ paypal_router.py         # PayPal integration
‚îÇ   ‚îî‚îÄ‚îÄ crypto/                      # Cryptocurrency payments
‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
‚îÇ       ‚îî‚îÄ‚îÄ web3_handler.py
‚îú‚îÄ‚îÄ blockchain/                      # Blockchain receipts
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ contracts/                   # Smart contracts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ DonationReceipt.sol
‚îÇ   ‚îú‚îÄ‚îÄ receipt_minter.py            # NFT minting
‚îÇ   ‚îî‚îÄ‚îÄ ipfs_client.py               # IPFS storage
‚îú‚îÄ‚îÄ utils/                           # Shared utilities
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ redis_client.py              # Redis connection
‚îÇ   ‚îî‚îÄ‚îÄ logger.py                    # Logging configuration
‚îî‚îÄ‚îÄ tests/                           # Test suite
    ‚îú‚îÄ‚îÄ __init__.py
    ‚îú‚îÄ‚îÄ test_api.py
    ‚îú‚îÄ‚îÄ test_ai.py
    ‚îî‚îÄ‚îÄ test_payments.py
```

---

## Step 1: Create Project Directory Structure

### üìö Background: Why This Structure?

**Modular Design:**
- `database/` - All database-related code in one place
- `voice/` - Multi-channel voice interfaces (IVR, Telegram, WhatsApp)
- `payments/` - Payment processing isolated for PCI compliance
- `blockchain/` - Blockchain receipts separate from core logic
- `utils/` - Shared code prevents duplication

**Benefits:**
- Easy to navigate for new developers
- Clear separation of concerns
- Simple to test individual modules
- Scales as project grows

### üíª Complete Setup Commands

Open your terminal and run these commands **exactly as shown**:

```bash
# Navigate to project root (already exists)
cd /Users/manu/Trust-Voice

# Create virtual environment (Python 3.11+)
python3 -m venv venv

# Activate virtual environment
# macOS/Linux:
source venv/bin/activate

# Verify activation (should show path to venv)
which python

# Create all project directories in one command
mkdir -p database/migrations \
         voice/{routers,ai,asr,tasks} \
         payments/{routers,crypto} \
         blockchain/contracts \
         utils \
         tests

# Create __init__.py files to make directories Python packages
touch database/__init__.py \
      database/migrations/__init__.py \
      voice/__init__.py \
      voice/routers/__init__.py \
      voice/ai/__init__.py \
      voice/asr/__init__.py \
      voice/tasks/__init__.py \
      payments/__init__.py \
      payments/routers/__init__.py \
      payments/crypto/__init__.py \
      blockchain/__init__.py \
      utils/__init__.py \
      tests/__init__.py

# Verify structure was created
tree -L 3 -I 'venv|__pycache__|*.pyc|documentation'
```

**Expected Output:**
```
.
‚îú‚îÄ‚îÄ blockchain
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îî‚îÄ‚îÄ contracts
‚îú‚îÄ‚îÄ database
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îî‚îÄ‚îÄ migrations
‚îÇ       ‚îî‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ main.py
‚îú‚îÄ‚îÄ payments
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ crypto
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ __init__.py
‚îÇ   ‚îî‚îÄ‚îÄ routers
‚îÇ       ‚îî‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ tests
‚îÇ   ‚îî‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ utils
‚îÇ   ‚îî‚îÄ‚îÄ __init__.py
‚îî‚îÄ‚îÄ voice
    ‚îú‚îÄ‚îÄ __init__.py
    ‚îú‚îÄ‚îÄ ai
    ‚îÇ   ‚îî‚îÄ‚îÄ __init__.py
    ‚îú‚îÄ‚îÄ asr
    ‚îÇ   ‚îî‚îÄ‚îÄ __init__.py
    ‚îú‚îÄ‚îÄ routers
    ‚îÇ   ‚îî‚îÄ‚îÄ __init__.py
    ‚îî‚îÄ‚îÄ tasks
        ‚îî‚îÄ‚îÄ __init__.py
```

---

## Step 2: Install Core Dependencies

### üìö Background: Dependency Management

**Virtual Environment (venv):**
- Isolates project dependencies from system Python
- Prevents version conflicts with other projects
- Makes deployment reproducible (`requirements.txt`)
- Used in your sister project - proven workflow

**Why These Dependencies:**

| Package | Purpose | Version |
|---------|---------|---------|
| `fastapi` | Async web framework | Latest |
| `uvicorn` | ASGI server for FastAPI | Latest |
| `sqlalchemy` | ORM for database | 2.0+ |
| `psycopg2-binary` | PostgreSQL driver | Latest |
| `alembic` | Database migrations | Latest |
| `redis` | Session caching | Latest |
| `celery` | Async task queue | Latest |
| `python-dotenv` | Load `.env` variables | Latest |

### üíª Installation Commands

```bash
# Ensure venv is activated (should see (venv) in prompt)
source venv/bin/activate

# Upgrade pip first
pip install --upgrade pip

# Install core dependencies
pip install fastapi uvicorn[standard] sqlalchemy psycopg2-binary alembic redis celery python-dotenv

# Install AI/ML libraries
pip install openai langchain pinecone-client

# Install payment libraries
pip install stripe paypal-sdk web3

# Install communication libraries
pip install twilio python-telegram-bot

# Install utilities
pip install pydantic python-multipart requests httpx

# Install testing libraries
pip install pytest pytest-asyncio httpx

# Freeze dependencies to requirements.txt
pip freeze > requirements.txt

# Verify installation
pip list
```

---

## Step 3: Create Environment Configuration

### üìö Background: Environment Variables

**Why `.env` Files:**
- **Security:** Never commit API keys to Git
- **Flexibility:** Different configs for dev/staging/prod
- **Best Practice:** 12-factor app methodology
- **Team Collaboration:** Each developer has their own `.env`

**What Goes in `.env`:**
- API keys (OpenAI, Stripe, Twilio)
- Database credentials
- Secret keys
- Service URLs

**What Doesn't:**
- Public information
- Code logic
- Default values (those go in code with `os.getenv('KEY', 'default')`)

### üíª Create `.env` File

```bash
# Create .env file
cat > .env << 'EOF'
# ============================================
# TrustVoice Environment Variables
# ============================================
# NEVER COMMIT THIS FILE TO GIT!
# Copy .env.example for team members
# ============================================

# ============================================
# DATABASE
# ============================================
# Local: postgresql://user:password@localhost:5432/trustvoice
# Neon (production): Get from https://neon.tech
DATABASE_URL=postgresql://user:password@localhost:5432/trustvoice

# ============================================
# REDIS (Session Caching)
# ============================================
# Local: redis://localhost:6379
# Production: Get from Redis Cloud
REDIS_URL=redis://localhost:6379

# ============================================
# AI/ML APIs
# ============================================
# OpenAI (European languages: EN/FR/DE/IT)
# Get from: https://platform.openai.com/api-keys
OPENAI_API_KEY=sk-proj-your-key-here

# Addis AI (Amharic/Swahili native)
# Get from: https://addisassistant.com
ADDIS_AI_API_KEY=sk_your-key-here
ADDIS_AI_URL=https://api.addisassistant.com/api/v1/chat_generate
ADDIS_TRANSLATE_URL=https://api.addisassistant.com/api/v1/translate

# ElevenLabs (Text-to-Speech)
# Get from: https://elevenlabs.io
ELEVENLABS_API_KEY=your-key-here

# Pinecone (Vector Database for RAG)
# Get from: https://www.pinecone.io
PINECONE_API_KEY=your-key-here
PINECONE_ENVIRONMENT=us-west1-gcp

# ============================================
# PAYMENT PROCESSING
# ============================================
# Stripe (Primary payment processor)
# Get from: https://dashboard.stripe.com/test/apikeys
STRIPE_SECRET_KEY=sk_test_your-key-here
STRIPE_PUBLISHABLE_KEY=pk_test_your-key-here
STRIPE_WEBHOOK_SECRET=whsec_your-webhook-secret

# PayPal (Alternative payment processor)
# Get from: https://developer.paypal.com
PAYPAL_CLIENT_ID=your-client-id
PAYPAL_CLIENT_SECRET=your-client-secret
PAYPAL_MODE=sandbox

# ============================================
# COMMUNICATION CHANNELS
# ============================================
# Twilio (IVR + WhatsApp)
# Get from: https://console.twilio.com
TWILIO_ACCOUNT_SID=ACxxxxxxxxxxxxxxxxxxxxxxxxxx
TWILIO_AUTH_TOKEN=your-auth-token
TWILIO_PHONE_NUMBER=+1234567890
TWILIO_WHATSAPP_NUMBER=whatsapp:+1234567890

# Telegram Bot
# Get from: https://t.me/BotFather
TELEGRAM_BOT_TOKEN=1234567890:ABCdefGHIjklMNOpqrsTUVwxyz

# ============================================
# BLOCKCHAIN (Optional - MVP can skip)
# ============================================
# Polygon RPC (for NFT receipts)
POLYGON_RPC_URL=https://polygon-rpc.com
POLYGON_PRIVATE_KEY=your-private-key-here

# IPFS (NFT.storage - free tier available)
# Get from: https://nft.storage
IPFS_API_KEY=your-ipfs-key

# ============================================
# APPLICATION SETTINGS
# ============================================
# Server
APP_ENV=development
APP_PORT=8000
APP_HOST=0.0.0.0

# Security
SECRET_KEY=your-secret-key-for-jwt-etc
ALLOWED_ORIGINS=http://localhost:3000,http://localhost:8000

# Monitoring
SENTRY_DSN=https://your-sentry-dsn

EOF

echo ".env file created!"
```

### Create `.env.example` (Safe to Commit)

```bash
# Create template for team members
cat > .env.example << 'EOF'
# Copy this file to .env and fill in your values
# NEVER commit .env to Git!

DATABASE_URL=postgresql://user:password@localhost:5432/trustvoice
REDIS_URL=redis://localhost:6379
OPENAI_API_KEY=sk-proj-your-key-here
STRIPE_SECRET_KEY=sk_test_your-key-here
TWILIO_ACCOUNT_SID=ACxxxxxxxxx
TELEGRAM_BOT_TOKEN=1234567890:ABC...
EOF
```

### Update `.gitignore`

```bash
# Create/update .gitignore
cat > .gitignore << 'EOF'
# Virtual Environment
venv/
env/
ENV/

# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python

# Environment Variables
.env
.env.local
.env.*.local

# Database
*.db
*.sqlite3
database/migrations/versions/*.py

# IDE
.vscode/
.idea/
*.swp
*.swo

# OS
.DS_Store
Thumbs.db

# Logs
*.log
logs/

# Testing
.pytest_cache/
.coverage
htmlcov/

# Build
dist/
build/
*.egg-info/
EOF

echo ".gitignore created!"
```

---

## Step 4: Create Database Models

### üìö Background: SQLAlchemy ORM

**Why SQLAlchemy:**
- **Type Safety:** Python classes ‚Üí SQL tables
- **Relationships:** Easy foreign keys and joins
- **Migrations:** Track schema changes with Alembic
- **Database Agnostic:** Works with PostgreSQL, MySQL, SQLite

**Database Design Principles:**
- **Normalization:** No duplicate data (e.g., campaign info not repeated in donations)
- **Indexes:** Fast lookups on phone numbers, campaign IDs
- **Relationships:** One NGO ‚Üí Many Campaigns ‚Üí Many Donations
- **Timestamps:** Track creation/updates for debugging

### üíª Create `database/models.py`

```python
"""
TrustVoice Database Models

This module defines all SQLAlchemy models for the TrustVoice platform.

Architecture:
- Donors: Individual users who donate via voice/chat
- NGOs: Organizations running campaigns
- Campaigns: Fundraising projects (e.g., "Mwanza Water Project")
- Donations: Individual contributions linked to donors and campaigns
- Impact Verifications: Field officer reports proving project completion
- Conversation Logs: AI conversation history for debugging/improvement
- Campaign Context: FAQ/story content for RAG (vector search)
"""

from sqlalchemy import (
    Column, Integer, String, Float, Boolean, DateTime, 
    Text, ForeignKey, ARRAY
)
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from datetime import datetime

Base = declarative_base()


class Donor(Base):
    """
    Individual donor who interacts via phone/Telegram/WhatsApp.
    
    Key Fields:
    - preferred_language: Set during registration (en/fr/de/it/am/sw)
      Used to route to correct AI (GPT-4 vs Addis AI)
    - phone_number: For IVR calls
    - telegram_user_id: For Telegram messages
    - whatsapp_number: For WhatsApp messages
    
    A donor may have multiple contact methods.
    """
    __tablename__ = "donors"
    
    id = Column(Integer, primary_key=True)
    
    # Contact Methods (at least one required)
    phone_number = Column(String(20), unique=True, index=True)
    telegram_user_id = Column(String(50), unique=True, index=True)
    whatsapp_number = Column(String(20), unique=True, index=True)
    
    # Profile
    preferred_name = Column(String(100))
    preferred_language = Column(String(10), default="en")  # CRITICAL: No auto-detection
    email = Column(String(255))
    country_code = Column(String(2))  # ISO 3166-1 alpha-2 (e.g., "DE", "US")
    
    # Payment Info
    blockchain_wallet_address = Column(String(66))  # Ethereum address (optional)
    stripe_customer_id = Column(String(100))  # Stripe Customer ID (auto-created)
    
    # Stats
    total_donated_usd = Column(Float, default=0.0)
    is_verified = Column(Boolean, default=False)  # Email/phone verified
    
    # Timestamps
    created_at = Column(DateTime, default=datetime.utcnow)
    last_interaction = Column(DateTime)
    
    # Relationships
    donations = relationship("Donation", back_populates="donor")


class NGOOrganization(Base):
    """
    NGO running fundraising campaigns.
    
    Examples:
    - WaterAid Tanzania
    - Ethiopian Education Foundation
    - Healthcare for All Kenya
    """
    __tablename__ = "ngo_organizations"
    
    id = Column(Integer, primary_key=True)
    
    # Basic Info
    name = Column(String(255), nullable=False)
    registration_number = Column(String(100))  # Government registration
    country = Column(String(100))
    contact_email = Column(String(255))
    admin_phone = Column(String(20))
    
    # Financial
    blockchain_wallet_address = Column(String(66))  # Where funds are sent
    stripe_account_id = Column(String(100))  # Stripe Connect account
    
    # Status
    is_active = Column(Boolean, default=True)
    created_at = Column(DateTime, default=datetime.utcnow)
    
    # Relationships
    campaigns = relationship("Campaign", back_populates="ngo")


class Campaign(Base):
    """
    Individual fundraising project.
    
    Example:
    - Title: "Clean Water for Mwanza"
    - Goal: $50,000
    - Description: "Build 10 wells serving 3,000 families"
    - Location: Mwanza, Tanzania (-2.5164, 32.9175)
    """
    __tablename__ = "campaigns"
    
    id = Column(Integer, primary_key=True)
    ngo_id = Column(Integer, ForeignKey("ngo_organizations.id"), nullable=False)
    
    # Basic Info
    title = Column(String(255), nullable=False)
    description = Column(Text)
    goal_amount_usd = Column(Float, nullable=False)
    raised_amount_usd = Column(Float, default=0.0)
    
    # Classification
    category = Column(String(50))  # water, education, health, infrastructure
    
    # Location
    location_country = Column(String(100))
    location_region = Column(String(100))
    location_gps = Column(String(100))  # "latitude,longitude"
    
    # Status
    status = Column(String(20), default="active")  # active, paused, completed, cancelled
    
    # Dates
    start_date = Column(DateTime)
    end_date = Column(DateTime)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    # Relationships
    ngo = relationship("NGOOrganization", back_populates="campaigns")
    donations = relationship("Donation", back_populates="campaign")
    verifications = relationship("ImpactVerification", back_populates="campaign")
    context_items = relationship("CampaignContext", back_populates="campaign")


class CampaignContext(Base):
    """
    Content for RAG (Retrieval-Augmented Generation).
    
    When donor asks "How will the money be used?", we search
    campaign_context table for relevant content using vector similarity.
    
    Content Types:
    - faq: Frequently asked questions
    - story: Beneficiary stories
    - budget: Detailed budget breakdown
    - partner_info: About implementing partners
    """
    __tablename__ = "campaign_context"
    
    id = Column(Integer, primary_key=True)
    campaign_id = Column(Integer, ForeignKey("campaigns.id"), nullable=False)
    
    content_type = Column(String(50))  # faq, story, budget, partner_info
    content = Column(Text, nullable=False)
    language = Column(String(10))  # en, fr, de, it, am, sw
    
    # Note: embedding_vector stored separately in Pinecone
    # (PostgreSQL pgvector extension is optional - adds complexity)
    
    created_at = Column(DateTime, default=datetime.utcnow)
    
    # Relationships
    campaign = relationship("Campaign", back_populates="context_items")


class Donation(Base):
    """
    Individual donation transaction.
    
    Lifecycle:
    1. pending: Payment intent created
    2. completed: Payment confirmed by Stripe/PayPal
    3. failed: Payment declined
    4. refunded: Donor requested refund
    """
    __tablename__ = "donations"
    
    id = Column(Integer, primary_key=True)
    donor_id = Column(Integer, ForeignKey("donors.id"), nullable=False)
    campaign_id = Column(Integer, ForeignKey("campaigns.id"), nullable=False)
    
    # Amount
    amount_usd = Column(Float, nullable=False)
    currency_code = Column(String(10), default="USD")  # EUR, GBP, USD
    original_amount = Column(Float)  # If currency != USD, store original
    
    # Payment Method
    payment_method = Column(String(20))  # stripe, paypal, crypto
    payment_intent_id = Column(String(255))  # Stripe Payment Intent ID
    transaction_hash = Column(String(66))  # If crypto, blockchain tx hash
    
    # Blockchain Receipt
    blockchain_receipt_url = Column(Text)  # IPFS URL with receipt NFT
    
    # Status
    status = Column(String(20), default="pending")
    
    # Optional Fields
    donor_message = Column(Text)  # "In memory of..."
    is_anonymous = Column(Boolean, default=False)
    tax_receipt_sent = Column(Boolean, default=False)
    
    # Timestamps
    created_at = Column(DateTime, default=datetime.utcnow)
    completed_at = Column(DateTime)
    
    # Relationships
    donor = relationship("Donor", back_populates="donations")
    campaign = relationship("Campaign", back_populates="donations")


class ImpactVerification(Base):
    """
    Field officer report proving project completion.
    
    Example:
    - Campaign: Mwanza Water Project
    - Verifier: Ibrahim (WaterAid field officer)
    - Type: milestone_completed
    - Description: "Well #3 completed, serving 450 families"
    - Audio: 30-second voice recording (IPFS URL)
    - Photos: [well_photo1.jpg, well_photo2.jpg] (IPFS URLs)
    - GPS: -2.5164, 32.9175
    - Blockchain: Anchored to Polygon with tx hash
    
    This verification is linked to all $100 donor receipts.
    """
    __tablename__ = "impact_verifications"
    
    id = Column(Integer, primary_key=True)
    campaign_id = Column(Integer, ForeignKey("campaigns.id"), nullable=False)
    
    # Field Officer Info
    verifier_phone = Column(String(20))
    verifier_name = Column(String(100))
    
    # Verification Details
    verification_type = Column(String(50))  # milestone, completion, beneficiary_count
    description = Column(Text)
    
    # Media
    audio_recording_url = Column(Text)  # IPFS URL
    photo_urls = Column(ARRAY(Text))  # Array of IPFS URLs
    
    # Location & Impact
    gps_coordinates = Column(String(100))  # "latitude,longitude"
    beneficiary_count = Column(Integer)  # Number of people impacted
    
    # Blockchain Anchor
    blockchain_anchor_tx = Column(String(66))  # Polygon transaction hash
    
    # Timestamp
    verified_at = Column(DateTime, default=datetime.utcnow)
    
    # Relationships
    campaign = relationship("Campaign", back_populates="verifications")


class ConversationLog(Base):
    """
    Logs all AI conversations for debugging and improvement.
    
    Use Cases:
    - Debug why AI misunderstood donor intent
    - Calculate LLM token usage (costs)
    - Improve conversation flows
    - Compliance (GDPR: user can request conversation history)
    """
    __tablename__ = "conversation_logs"
    
    id = Column(Integer, primary_key=True)
    donor_id = Column(Integer, ForeignKey("donors.id"))
    
    # Channel Info
    channel = Column(String(20))  # ivr, telegram, whatsapp
    session_id = Column(String(100))  # Groups messages in same conversation
    
    # Message Content
    message_type = Column(String(20))  # user, assistant, system
    message_text = Column(Text)
    
    # AI Metadata
    intent_detected = Column(String(50))  # ask_campaign_info, initiate_donation, etc.
    entities_extracted = Column(Text)  # JSON: {"campaign_id": 5, "amount": 100}
    llm_model = Column(String(50))  # gpt-4-turbo, addis-ai-am
    llm_tokens_used = Column(Integer)
    
    # Timestamp
    created_at = Column(DateTime, default=datetime.utcnow)
```

---

## Step 5: Create Database Utilities

### üíª Create `database/db.py`

```python
"""
Database connection utilities.

Provides:
- Database engine creation
- Session management with context manager
- Helper functions for common queries
"""

import os
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker, Session
from contextlib import contextmanager
from typing import Optional
import logging

from database.models import Base, Donor, Campaign, NGOOrganization

logger = logging.getLogger(__name__)

# Get database URL from environment
DATABASE_URL = os.getenv("DATABASE_URL")

if not DATABASE_URL:
    raise ValueError("DATABASE_URL environment variable not set!")

# Create engine
# pool_pre_ping=True: Check connection health before using
engine = create_engine(
    DATABASE_URL,
    pool_pre_ping=True,
    echo=False  # Set to True to see SQL queries (debugging)
)

# Session factory
SessionLocal = sessionmaker(
    bind=engine,
    expire_on_commit=False,
    autoflush=False
)


@contextmanager
def get_db() -> Session:
    """
    Context manager for database sessions.
    
    Usage:
        with get_db() as db:
            donor = db.query(Donor).filter_by(id=1).first()
            # Session auto-commits on success, rolls back on error
    
    Benefits:
    - Automatic commit on success
    - Automatic rollback on exception
    - Ensures connection is closed
    """
    db = SessionLocal()
    try:
        yield db
        db.commit()
    except Exception as e:
        db.rollback()
        logger.error(f"Database error: {e}")
        raise
    finally:
        db.close()


def create_tables():
    """
    Create all tables in database.
    
    WARNING: Only use in development!
    Production should use Alembic migrations.
    """
    Base.metadata.create_all(bind=engine)
    logger.info("Database tables created")


def drop_tables():
    """
    Drop all tables in database.
    
    WARNING: DESTRUCTIVE! Only use in testing.
    """
    Base.metadata.drop_all(bind=engine)
    logger.warning("All database tables dropped")


# ============================================
# Helper Functions for Common Queries
# ============================================

def get_donor_by_phone(phone: str) -> Optional[Donor]:
    """Get donor by phone number."""
    with get_db() as db:
        return db.query(Donor).filter_by(phone_number=phone).first()


def get_donor_by_telegram_id(telegram_id: str) -> Optional[Donor]:
    """Get donor by Telegram user ID."""
    with get_db() as db:
        return db.query(Donor).filter_by(telegram_user_id=telegram_id).first()


def get_donor_by_whatsapp(whatsapp_number: str) -> Optional[Donor]:
    """Get donor by WhatsApp number."""
    with get_db() as db:
        return db.query(Donor).filter_by(whatsapp_number=whatsapp_number).first()


def get_active_campaigns():
    """Get all active campaigns."""
    with get_db() as db:
        return db.query(Campaign).filter_by(status="active").all()


def get_campaign_by_id(campaign_id: int) -> Optional[Campaign]:
    """Get campaign by ID."""
    with get_db() as db:
        return db.query(Campaign).filter_by(id=campaign_id).first()
```

---

## Step 6: Create FastAPI Application

### üìö Background: FastAPI Basics

**Why FastAPI:**
- **Async Support:** Handle 1000+ concurrent users
- **Auto Documentation:** Swagger UI at `/docs`
- **Type Validation:** Pydantic models catch errors early
- **Fast:** Performance comparable to Node.js/Go

### üíª Create `main.py`

```python
"""
TrustVoice FastAPI Application

Entry point for the voice-first donation platform.
"""

import os
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from dotenv import load_dotenv
import logging

# Load environment variables
load_dotenv()

# Configure logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# Create FastAPI app
app = FastAPI(
    title="TrustVoice API",
    description="Voice-first donation platform with blockchain receipts",
    version="1.0.0"
)

# CORS configuration (allow web dashboard to call API)
ALLOWED_ORIGINS = os.getenv("ALLOWED_ORIGINS", "http://localhost:3000").split(",")
app.add_middleware(
    CORSMiddleware,
    allow_origins=ALLOWED_ORIGINS,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)


# ============================================
# Health Check Endpoint
# ============================================

@app.get("/health")
async def health_check():
    """
    Health check endpoint for monitoring.
    
    Returns server status and basic info.
    Used by:
    - Monitoring services (UptimeRobot, Pingdom)
    - Load balancers
    - Deployment systems (Railway, Render)
    """
    return {
        "status": "healthy",
        "service": "TrustVoice API",
        "version": "1.0.0",
        "environment": os.getenv("APP_ENV", "development")
    }


@app.get("/")
async def root():
    """Root endpoint with API information."""
    return {
        "message": "Welcome to TrustVoice API",
        "documentation": "/docs",
        "health": "/health"
    }


# ============================================
# TODO: Include routers (Lab 2+)
# ============================================
# from voice.routers import ivr, telegram, whatsapp
# from payments.routers import stripe_router, paypal_router
#
# app.include_router(ivr.router, prefix="/voice/ivr", tags=["IVR"])
# app.include_router(telegram.router, prefix="/voice/telegram", tags=["Telegram"])
# app.include_router(whatsapp.router, prefix="/voice/whatsapp", tags=["WhatsApp"])
# app.include_router(stripe_router, prefix="/payments/stripe", tags=["Stripe"])


# ============================================
# Startup/Shutdown Events
# ============================================

@app.on_event("startup")
async def startup_event():
    """Run on application startup."""
    logger.info("TrustVoice API starting up...")
    logger.info(f"Environment: {os.getenv('APP_ENV')}")
    logger.info(f"Database: {os.getenv('DATABASE_URL', 'Not configured')[:30]}...")
    
    # TODO: Initialize database connection pool
    # TODO: Connect to Redis
    # TODO: Warm up AI models


@app.on_event("shutdown")
async def shutdown_event():
    """Run on application shutdown."""
    logger.info("TrustVoice API shutting down...")
    # TODO: Close database connections
    # TODO: Close Redis connection
    # TODO: Cleanup resources


# ============================================
# Run Server (Development Only)
# ============================================

if __name__ == "__main__":
    import uvicorn
    
    port = int(os.getenv("APP_PORT", 8000))
    host = os.getenv("APP_HOST", "0.0.0.0")
    
    logger.info(f"Starting server on {host}:{port}")
    
    uvicorn.run(
        "main:app",
        host=host,
        port=port,
        reload=True,  # Auto-reload on code changes (dev only!)
        log_level="info"
    )
```

---

## Step 7: Test the Setup

### üß™ Verification Steps

```bash
# Ensure venv is activated
source venv/bin/activate

# Run the FastAPI server
python main.py
```

**Expected Output:**
```
INFO:     Will watch for changes in these directories: ['/Users/manu/Trust-Voice']
INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
INFO:     Started reloader process [12345] using StatReload
INFO:     Started server process [12346]
INFO:     Waiting for application startup.
TrustVoice API starting up...
INFO:     Application startup complete.
```

### Test Endpoints

**Open browser:**
- http://localhost:8000 ‚Üí Root endpoint
- http://localhost:8000/health ‚Üí Health check
- http://localhost:8000/docs ‚Üí Swagger UI (auto-generated API docs!)

**Using curl:**
```bash
# Test health endpoint
curl http://localhost:8000/health

# Expected response:
{
  "status": "healthy",
  "service": "TrustVoice API",
  "version": "1.0.0",
  "environment": "development"
}
```

---

## Step 8: Initialize Database (Optional - Local Testing)

### üíª Setup Local PostgreSQL

If you want to test locally before using Neon:

```bash
# Install PostgreSQL (macOS)
brew install postgresql@15

# Start PostgreSQL service
brew services start postgresql@15

# Create database
createdb trustvoice

# Update .env with local connection
DATABASE_URL=postgresql://$(whoami)@localhost:5432/trustvoice
```

### Create Tables

```python
# Create test script: scripts/init_db.py
from database.db import create_tables, engine
from database.models import Base

if __name__ == "__main__":
    print("Creating database tables...")
    create_tables()
    print("‚úÖ Tables created successfully!")
    
    # Print table names
    print("\nTables:")
    for table_name in Base.metadata.tables.keys():
        print(f"  - {table_name}")
```

```bash
# Run initialization
python scripts/init_db.py
```

---

## ‚úÖ Lab 1 Completion Checklist

Verify you have completed all steps:

- [ ] Virtual environment created and activated (`venv/`)
- [ ] All project directories created (use `tree` to verify)
- [ ] All `__init__.py` files created
- [ ] Dependencies installed (`pip list` shows fastapi, sqlalchemy, etc.)
- [ ] `requirements.txt` generated with `pip freeze`
- [ ] `.env` file created with placeholders
- [ ] `.env.example` created (safe to commit)
- [ ] `.gitignore` configured properly
- [ ] `database/models.py` created with all 7 models
- [ ] `database/db.py` created with utilities
- [ ] `main.py` created and runs successfully
- [ ] Can access http://localhost:8000/docs
- [ ] Health check returns `{"status": "healthy"}`

---

## üìö What We Accomplished

**Project Structure:** ‚úÖ
- Complete directory tree ready to be filled
- Modular design (voice, payments, blockchain separate)
- All Python packages properly initialized

**Virtual Environment:** ‚úÖ
- Isolated dependencies from system Python
- `requirements.txt` for reproducible installs
- Ready for team collaboration

**Database Foundation:** ‚úÖ
- 7 SQLAlchemy models defined
- Relationships configured (donors ‚Üí donations ‚Üí campaigns)
- Helper functions for common queries
- Ready for Alembic migrations (Lab 2)

**FastAPI Server:** ‚úÖ
- Runs on http://localhost:8000
- Auto-generated API docs at `/docs`
- Health check endpoint
- Structured for adding routers

**Configuration:** ‚úÖ
- Environment variables in `.env` (secure)
- `.gitignore` prevents committing secrets
- Logging configured
- CORS enabled for web dashboard

---

## üöÄ Next Steps (Lab 2)

In the next lab, we'll:
1. Set up Alembic migrations
2. Create campaign and donor management APIs
3. Add first database entries (seed data)
4. Build admin endpoints for NGOs
5. Test CRUD operations

---

## üí° Key Takeaways

**Virtual Environment Best Practices:**
- ‚úÖ Always activate before working: `source venv/bin/activate`
- ‚úÖ Keep `requirements.txt` updated: `pip freeze > requirements.txt`
- ‚úÖ Never commit `venv/` folder to Git
- ‚úÖ Deactivate when done: `deactivate`

**Directory Structure:**
- Modular design = easier to maintain
- Clear separation of concerns
- Scales as project grows
- Easy for new developers to navigate

**Environment Variables:**
- NEVER commit API keys to Git
- Use `.env` for secrets, `.env.example` for template
- Load with `python-dotenv` in development
- Production: Use Railway/Render secrets management

**Database Models:**
- Define relationships upfront (prevents refactoring later)
- Add indexes on frequently queried fields (phone_number, telegram_id)
- Use timestamps for debugging
- SQLAlchemy handles SQL generation (write less code)

---

## üéì Common Gotchas

### Problem: `ModuleNotFoundError: No module named 'fastapi'`

**Cause:** Virtual environment not activated or dependencies not installed

**Solution:**
```bash
source venv/bin/activate
pip install -r requirements.txt
```

---

### Problem: `ImportError: cannot import name 'Donor' from 'database.models'`

**Cause:** Missing `__init__.py` files

**Solution:**
```bash
touch database/__init__.py
touch voice/__init__.py
# Ensure all package directories have __init__.py
```

---

### Problem: `sqlalchemy.exc.OperationalError: could not connect to server`

**Cause:** Database URL incorrect or PostgreSQL not running

**Solution:**
```bash
# Check DATABASE_URL in .env
echo $DATABASE_URL

# Start PostgreSQL (if using local)
brew services start postgresql@15

# Or update .env to use Neon URL
```

---

### Problem: FastAPI docs not showing at /docs

**Cause:** Server not running or wrong port

**Solution:**
```bash
# Check server is running
python main.py

# Access at correct URL
# http://localhost:8000/docs (NOT 127.0.0.1)
```

---

## üîí Security Considerations

**Environment Variables:**
- ‚úÖ Never commit `.env` to Git
- ‚úÖ Rotate API keys regularly
- ‚úÖ Use different keys for dev/staging/prod
- ‚úÖ Restrict API key permissions (e.g., Stripe test keys for development)

**Database:**
- ‚úÖ Use connection pooling (prevents exhausting connections)
- ‚úÖ Never log sensitive data (donor phone numbers, payment info)
- ‚úÖ Implement soft deletes (set `is_active=False` instead of DELETE)

**Dependencies:**
- ‚úÖ Keep `requirements.txt` updated
- ‚úÖ Run `pip audit` to check for vulnerabilities
- ‚úÖ Use specific versions in production (`fastapi==0.100.0`, not `fastapi>=0.100.0`)

---

## üí∞ Cost Considerations (So Far)

**Development (Lab 1):**
- Virtual environment: Free
- PostgreSQL local: Free
- FastAPI: Free (open source)
- Python: Free

**Production (After Deployment):**
- Neon PostgreSQL: $20/month (paid tier for production)
- Railway/Render: $50/month (basic tier)
- **Total: ~$70/month** (before API costs)

Lab 1 is completely free to run locally!

---

## üìù Summary

**What We Built:**
- Complete project structure with 9 directories
- Virtual environment with 20+ dependencies
- 7 database models (donors, campaigns, donations, etc.)
- FastAPI server with health check
- Proper environment variable management
- Security best practices (.gitignore, .env)

**Time Investment:** 2-3 hours  
**Lines of Code:** ~700 lines  
**Cost:** $0 (local development)

**Foundation Status:** ‚úÖ SOLID

You now have a production-ready project structure. All future labs will fill in the routers, AI logic, payment integration, and blockchain components.

---

**Ready for Lab 2?** Let's build the campaign and donor management APIs!
